// ==UserScript==
// @name         Quinoa WS ModMenu (page+worker+HUD)
// @namespace    romann.quinoa.ws
// @version      0.3.0
// @description  Hook WS (page/worker) + HUD modulable (Alt+X, +/-) pour Quinoa
// @match        https://*.discordsays.com/*
// @run-at       document-start
// @all-frames   true
// @inject-into  page
// @grant        none
// @downloadURL  http://localhost:5174/quinoa-ws.user.js
// @updateURL    http://localhost:5174/quinoa-ws.user.js
// ==/UserScript==

(()=>{var Kt=Object.defineProperty;var $t=(t,e,n)=>e in t?Kt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var V=(t,e,n)=>$t(t,typeof e!="symbol"?e+"":e,n);var J=window.WebSocket,ke=window.Worker,Z=[],be=null;function he(t,e){if(!be){be=t;try{console.log("[QuinoaWS] selected ->",e)}catch{}}}var qe=!1;function dt(t){qe=!!t,window.__QWS_workerFound=qe}var ae=typeof Set<"u"?new Set:{_a:[],add(t){this._a.push(t)},delete(t){let e=this._a.indexOf(t);e>=0&&this._a.splice(e,1)},forEach(t){for(let e=0;e<this._a.length;e++)t(this._a[e])}};async function mt(t){try{if(typeof t=="string")return JSON.parse(t);if(t instanceof Blob)return JSON.parse(await t.text());if(t instanceof ArrayBuffer)return JSON.parse(new TextDecoder().decode(t))}catch{}return null}function pt(){function t(e,n){let a=n!==void 0?new J(e,n):new J(e);Z.push(a),a.addEventListener("open",()=>{setTimeout(()=>{a.readyState===J.OPEN&&he(a,"open-fallback")},800)}),a.addEventListener("message",async r=>{let l=await mt(r.data);l&&!window.quinoaWS&&(l.type==="Welcome"||l.type==="Config"||l.fullState||l.config)&&he(a,"message:"+(l.type||"state"))});let i=a.send.bind(a);return a.send=function(r){try{let l=null;typeof r=="string"?l=JSON.parse(r):r instanceof ArrayBuffer&&(l=JSON.parse(new TextDecoder().decode(r))),!window.quinoaWS&&l&&Array.isArray(l.scopePath)&&l.scopePath.join("/")==="Room/Quinoa"&&he(a,"send:"+l.type)}catch{}return i(r)},a}t.prototype=J.prototype;try{t.OPEN=J.OPEN}catch{}try{t.CLOSED=J.CLOSED}catch{}try{t.CLOSING=J.CLOSING}catch{}try{t.CONNECTING=J.CONNECTING}catch{}window.WebSocket=t}function Ut(){return`(function(){
    if (self.__QW_I__) return; self.__QW_I__=1;
    var N=self.WebSocket; var W=null;
    function P(r){
      try{
        if(typeof r==='string') return JSON.parse(r);
        if(r instanceof Blob) return r.text().then(function(t){return JSON.parse(t)}).catch(function(){return null});
        if(r instanceof ArrayBuffer) return JSON.parse(new TextDecoder().decode(r));
      }catch(e){} return null;
    }
    self.WebSocket=function(u,p){
      var w=p?new N(u,p):new N(u);
      w.addEventListener('message',function(e){
        var pr=P(e.data);
        if(pr&&typeof pr.then==='function'){
          pr.then(function(j){
            if(j&&(j.type==='Welcome'||j.type==='Config'||j.fullState||j.config)){
              W=w; try{ self.postMessage({__QWS_EVT:'found'}) }catch(e){}
            }
          });
        } else {
          var j=pr;
          if(j&&(j.type==='Welcome'||j.type==='Config'||j.fullState||j.config)){
            W=w; try{ self.postMessage({__QWS_EVT:'found'}) }catch(e){}
          }
        }
      });
      var s=w.send;
      w.send=function(d){
        try{
          var j=typeof d==='string'?JSON.parse(d):null;
          if(j&&j.scopePath&&j.scopePath.join('/')==='Room/Quinoa'){
            W=w; try{ self.postMessage({__QWS_EVT:'found'}) }catch(e){}
          }
        }catch(e){}
        return s.apply(w,arguments);
      };
      return w;
    };
    self.WebSocket.prototype=N.prototype;
    try{ self.WebSocket.OPEN=N.OPEN }catch(e){}
    try{ self.WebSocket.CLOSED=N.CLOSED }catch(e){}
    try{ self.WebSocket.CLOSING=N.CLOSING }catch(e){}
    try{ self.WebSocket.CONNECTING=N.CONNECTING }catch(e){}

    self.addEventListener('message',function(e){
      var m=e&&e.data;
      if(m&&m.__QWS_CMD==='send'){
        try{
          if(W&&W.readyState===1){ W.send(m.payload); self.postMessage({__QWS_EVT:'sent',ok:true}) }
          else { self.postMessage({__QWS_EVT:'sent',ok:false}) }
        }catch(err){}
      }
    });
  })();`}function Vt(t){let e=Ut()+`
try{importScripts(${JSON.stringify(String(t))})}catch(e){}`,n=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(n)}function ft(t,e){ae.add?ae.add(t):ae.add(t),t.__qw_blob_url=e,t.addEventListener("message",a=>{let i=a&&a.data;i&&i.__QWS_EVT==="found"&&dt(!0)});let n=t.terminate.bind(t);t.terminate=function(){ae.delete&&ae.delete(t);try{e&&URL.revokeObjectURL(e)}catch{}return n.apply(t,arguments)}}function yt(){window.Worker=function(t,e){try{if(typeof t=="string"){let a=Vt(t),i=new ke(a,e);return ft(i,a),i}}catch{}let n=new ke(t,e);return ft(n),n},window.Worker.prototype=ke.prototype}var oe=null,Je=!1,bt=null,We=null,ht=()=>globalThis.jotaiAtomCache?.cache;function Yt(){let t=globalThis.__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!t?.renderers?.size)return null;for(let[e]of t.renderers){let n=t.getFiberRoots(e);for(let a of n){let i=new Set,r=[a.current];for(;r.length;){let l=r.pop();if(!l||i.has(l))continue;i.add(l);let s=l?.pendingProps?.value;if(s&&typeof s.get=="function"&&typeof s.set=="function"&&typeof s.sub=="function")return We="fiber",s;l.child&&r.push(l.child),l.sibling&&r.push(l.sibling),l.alternate&&r.push(l.alternate)}}}return null}async function zt(t=5e3){let e=ht();if(!e)throw new Error("jotaiAtomCache.cache introuvable");let n=null,a=null,i=[];for(let s of e.values()){if(!s||typeof s.write!="function")continue;let f=s.write;s.__origWrite=f,s.write=function(S,E,...A){if(!a){n=S,a=E;for(let N of i)N.write=N.__origWrite,delete N.__origWrite}return f.call(this,S,E,...A)},i.push(s)}let r=s=>new Promise(f=>setTimeout(f,s)),l=Date.now();try{globalThis.dispatchEvent?.(new Event("visibilitychange"))}catch{}for(;!a&&Date.now()-l<t;)await r(50);return a?(We="write",{get:s=>n(s),set:(s,f)=>a(s,f),sub:(s,f)=>{let S;try{S=n(s)}catch{}let E=setInterval(()=>{let A;try{A=n(s)}catch{return}if(A!==S){S=A;try{f()}catch{}}},100);return()=>clearInterval(E)}}):(We="polyfill",{get:()=>{throw new Error("Store non captur\xE9: get indisponible")},set:()=>{throw new Error("Store non captur\xE9: set indisponible")},sub:()=>()=>{},__polyfill:!0})}async function z(){if(oe)return oe;if(Je){let t=Date.now();for(;!oe&&Date.now()-t<3e3;)await new Promise(e=>setTimeout(e,25));if(oe)return oe}Je=!0;try{return oe=Yt()||await zt(),oe}catch(t){throw bt=t,t}finally{Je=!1}}function Se(){return!!oe&&!oe.__polyfill}function Ze(){return{via:We,polyfill:!!oe?.__polyfill,error:bt}}async function j(t){return(await z()).get(t)}async function re(t,e){(await z()).set(t,e)}async function ee(t,e){return(await z()).sub(t,e)}function Pe(t){let e=ht();if(!e)return[];let n=[];for(let a of e.values()){let i=a?.debugLabel||a?.label||"";t.test(String(i))&&n.push(a)}return n}function q(t){return Pe(new RegExp("^"+t+"$"))[0]||null}async function et(t){let e=q("sendQuinoaToastAtom");if(e){await re(e,t);return}let n=q("quinoaToastsAtom");if(!n)throw new Error("Aucun atom de toast trouv\xE9");let a=await j(n).catch(()=>[]),i={isClosable:!0,duration:1e4,...t};"toastType"in i&&i.toastType==="board"?i.id=i.id??(i.isStackable?`quinoa-stackable-${Date.now()}-${Math.random()}`:"quinoa-game-toast"):i.id=i.id??"quinoa-game-toast",await re(n,[...a,i])}async function ie(t,e="",n="info",a=null,i={}){return et({title:t,description:e,variant:n,icon:a,isClosable:!0,...i})}async function Jt(t,e,n,a="Blue.Magic",i=5e3,r={}){return et({toastType:"board",title:t,subtitle:e,backgroundImage:n,strokeColor:a,isStackable:!0,duration:i,...r})}async function Qt(){let t=q("quinoaToastsAtom");t&&await re(t,[])}var He=new Map;function Xt(t){try{return Pe(new RegExp("^"+t+"$"))}catch{return[]}}function Zt(t){if(t&&typeof t.read=="function")return"read";for(let e of Object.keys(t||{})){let n=t[e];if(typeof n=="function"&&e!=="write"&&e!=="onMount"&&e!=="toString"){let a=n.length;if(a===1||a===2)return e}}throw new Error("Impossible de localiser la fonction read() de l'atom")}function Fe(t){return He.get(t)||null}async function St(t){!t?.closeAction||!t?.openAction||(await t.closeAction(),await new Promise(e=>setTimeout(e,0)),await t.openAction())}async function en(t){let e=t.label,n=He.get(e);if(n?.installed)return n;let a=Xt(t.label);if(!a.length)throw new Error(`${t.label} introuvable`);let i=n??{config:t,enabled:!1,payload:null,patched:new Map,installed:!1},r=null;t.gate?.label&&(r=q(t.gate.label));for(let l of a){if(i.patched.has(l))continue;let s=Zt(l),f=l[s];l[s]=S=>{try{r&&S(r)}catch{}for(let A of t.extraDeps||[])try{let N=q(A);N&&S(N)}catch{}let E=f(S);return!i.enabled||i.payload==null?E:t.merge?t.merge(E,i.payload):i.payload},i.patched.set(l,{readKey:s,orig:f})}return r&&t.gate?.autoDisableOnClose&&(i.unsubGate=await ee(r,async()=>{let l;try{l=await j(r)}catch{l=null}!(t.gate?.isOpen?t.gate.isOpen(l):!!l)&&i.enabled&&(i.enabled=!1)})),i.installed=!0,He.set(e,i),i}async function Xe(t,e,n){await z();let a=await en(t);a.payload=e,a.enabled=!0,n?.merge&&!t.merge&&(t.merge=(i,r)=>r),n?.openGate&&t.gate?.openAction&&await t.gate.openAction(),a.autoTimer&&(clearTimeout(a.autoTimer),a.autoTimer=null),n?.autoRestoreMs&&n.autoRestoreMs>0&&(a.autoTimer=setTimeout(()=>{Oe(t.label)},n.autoRestoreMs))}async function tn(t,e){let n=Fe(t);if(!n?.installed)throw new Error(`Fake ${t} non install\xE9`);n.payload=e,await St(n.config.gate)}async function Oe(t){let e=Fe(t);e&&(e.enabled=!1,e.payload=null,e.autoTimer&&(clearTimeout(e.autoTimer),e.autoTimer=null),await St(e.config.gate))}async function nn(t){let e=Fe(t);if(e){for(let[n,a]of e.patched)try{n[a.readKey]=a.orig}catch{}if(e.patched.clear(),e.enabled=!1,e.payload=null,e.unsubGate){try{e.unsubGate()}catch{}e.unsubGate=void 0}e.autoTimer&&(clearTimeout(e.autoTimer),e.autoTimer=void 0),He.delete(t)}}function an(t){return!!Fe(t)?.enabled}var Be=(t,e=0)=>Number.isFinite(+t)?Math.trunc(+t):e,Qe=(t,e=0)=>Number.isFinite(+t)?+t:e;function on(t){if(!t||typeof t!="object")return null;let e={...t};switch(e.itemType||(e.toolId!=null?e.itemType="Tool":e.eggId!=null?e.itemType="Egg":e.petSpecies!=null?e.itemType="Pet":e.slots&&e.species?e.itemType="Plant":e.scale!=null&&e.species?e.itemType="Produce":e.species!=null&&(e.itemType="Seed")),String(e.itemType)){case"Tool":return e.toolId==null&&e.id!=null&&(e.toolId=String(e.id)),e.toolId==null?null:{itemType:"Tool",toolId:String(e.toolId),quantity:Be(e.quantity,1)};case"Seed":return e.species?{itemType:"Seed",species:String(e.species),quantity:Be(e.quantity,0)}:null;case"Egg":return e.eggId==null&&e.id!=null&&(e.eggId=String(e.id)),e.eggId==null?null:{itemType:"Egg",eggId:String(e.eggId),quantity:Be(e.quantity,0)};case"Plant":return e.species?{itemType:"Plant",id:String(e.id??Math.random().toString(36).slice(2)),species:String(e.species),slots:Array.isArray(e.slots)?e.slots.filter(n=>n&&typeof n=="object"):[],plantedAt:typeof e.plantedAt=="number"?e.plantedAt:null,maturedAt:typeof e.maturedAt=="number"?e.maturedAt:null}:null;case"Pet":return!e.petSpecies&&e.species&&(e.petSpecies=e.species),e.petSpecies?{itemType:"Pet",id:String(e.id??Math.random().toString(36).slice(2)),petSpecies:String(e.petSpecies),name:e.name??null,xp:Be(e.xp,0),hunger:Qe(e.hunger,0),mutations:Array.isArray(e.mutations)?e.mutations.slice(0,32):[],targetScale:Qe(e.targetScale,1),abilities:Array.isArray(e.abilities)?e.abilities.slice(0,32):[]}:null;case"Produce":return e.species?{itemType:"Produce",id:String(e.id??Math.random().toString(36).slice(2)),species:String(e.species),scale:Qe(e.scale,1),mutations:Array.isArray(e.mutations)?e.mutations.slice(0,32):[]}:null;default:return null}}function Ne(t){let e=Array.isArray(t?.items)?t.items:[],n=[];for(let r of e){let l=on(r);l&&n.push(l)}let a=new Set(n.filter(r=>r.itemType==="Pet"&&typeof r.id=="string").map(r=>r.id)),i=Array.isArray(t?.favoritedItemIds)?t.favoritedItemIds.filter(r=>typeof r=="string"&&a.has(r)):[];return{items:n,favoritedItemIds:i}}function gt(t){return!t||typeof t!="object"?Math.random().toString(36):t.itemType==="Seed"&&t.species?`Seed:${t.species}`:t.itemType==="Tool"&&t.toolId?`Tool:${t.toolId}`:t.itemType==="Egg"&&t.eggId?`Egg:${t.eggId}`:t.itemType==="Produce"&&t.id?`Produce:${t.id}`:t.id?`${t.itemType||"Item"}:${t.id}`:t.itemType==="Produce"&&t.species&&t.scale!=null?`Produce:${t.species}:${String(t.scale)}`:Math.random().toString(36)}function rn(t,e){let n=Ne(t||{items:[],favoritedItemIds:[]}),a=Ne(e||{items:[],favoritedItemIds:[]}),i=new Map;for(let l of n.items)i.set(gt(l),l);for(let l of a.items)i.set(gt(l),l);let r=new Set([...n.favoritedItemIds||[],...a.favoritedItemIds||[]]);return{items:[...i.values()],favoritedItemIds:[...r]}}async function De(){let t=q("activeModalAtom");t&&await re(t,"inventory")}async function tt(){let t=q("activeModalAtom");t&&await re(t,null)}function wt(t){return t==="inventory"}var Tt={label:"myInventoryAtom",merge:(t,e)=>rn(t,e),gate:{label:"activeModalAtom",isOpen:wt,openAction:De,closeAction:tt,autoDisableOnClose:!0}},xt={label:"myDataAtom",merge:(t,e)=>({...t&&typeof t=="object"?t:{},inventory:Ne(e)}),gate:{label:"activeModalAtom",isOpen:wt,openAction:De,closeAction:tt,autoDisableOnClose:!0}};async function nt(t,e){let n=Ne(t);e?.open!==!1&&await De();try{await Xe(xt,n,{merge:!0,openGate:!1,autoRestoreMs:e?.autoRestoreMs})}catch{}let a={...Tt};e?.merge===!1&&delete a.merge,await Xe(a,n,{merge:e?.merge,openGate:!1,autoRestoreMs:e?.autoRestoreMs})}async function sn(){await Oe(xt.label),await Oe(Tt.label)}async function Ie(t,e){let n=q("positionAtom");if(!n)throw new Error("positionAtom introuvable");await re(n,{x:t,y:e})}async function ln(){let t=q("positionAtom");return t?await j(t):null}var Ge={ensureStore:z,isStoreCaptured:Se,getCapturedInfo:Ze,jGet:j,jSet:re,jSub:ee,findAtomsByLabel:Pe,getAtomByLabel:q,sendToast:et,toastSimple:ie,toastBoard:Jt,clearToasts:Qt,fakeShow:Xe,fakeUpdate:tn,fakeHide:Oe,fakeDispose:nn,fakeIsEnabled:an,fakeInventoryShow:nt,fakeInventoryHide:sn,openInventoryPanel:De,closeInventoryPanel:tt,setLocalPlayerPosition:Ie,getLocalPlayerPosition:ln};function at(t){let e="qws:pos",n="qws:collapsed",a="qws:hidden";if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",()=>at(t),{once:!0});return}let r=`
  .qws2{position:fixed;right:16px;bottom:16px;z-index:999998;
    font:12px/1.4 system-ui;color:#fff;background:#111c;border:1px solid #fff3;border-radius:10px;
    padding:8px 10px;box-shadow:0 8px 30px rgba(0,0,0,.35);backdrop-filter:blur(4px);min-width:220px}
  .qws2.hidden{display:none}
  .qws2 .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .qws2 .col{display:flex;flex-direction:column;gap:4px}
  .qws2 .title{font-weight:600}
  .qws2 .sp{flex:1}
  .qws2 .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #ffffff30}
  .qws2 .ok{background:#24a14833}
  .qws2 .warn{background:#f1c21b33}
  .qws2 .bad{background:#da1e2833}
  .qws2 .btn{cursor:pointer;border-radius:8px;border:1px solid #ffffff30;padding:6px 10px;background:#ffffff12;color:#fff}
  .qws2 .btn:hover{background:#ffffff22}
  .qws2 .drag{cursor:move;opacity:.8}
  .qws2 .mini{display:none}
  .qws2.min .mini{display:block}
  .qws2.min .body{display:none}

  /* Launcher (toujours affich\xE9) */
  .qws-launch{margin-top:6px;border-top:1px solid #ffffff20;padding-top:6px;display:block}
  .qws-launch .launch-item{display:flex;align-items:center;gap:8px;margin:4px 0}
  .qws-launch .launch-item .name{flex:1}

  /* Fen\xEAtres flottantes */
  .qws-win{position:fixed;z-index:999999;min-width:260px;max-width:420px;max-height:70vh;overflow:auto;
    background:#111c;color:#fff;border:1px solid #fff3;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.45);backdrop-filter:blur(4px)}
  .qws-win .w-head{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid #ffffff20;cursor:move}
  .qws-win .w-title{font-weight:600}
  .qws-win .sp{flex:1}
  .qws-win .w-btn{cursor:pointer;border-radius:8px;border:1px solid #ffffff30;padding:4px 8px;background:#ffffff12;color:#fff}
  .qws-win .w-btn:hover{background:#ffffff22}
  .qws-win .w-body{padding:10px}

  /* Inputs g\xE9n\xE9riques */
  .qws-win input[type="text"], .qws-win input[type="number"]{
    width:110px;padding:6px 8px;border-radius:6px;border:1px solid #ffffff30;background:#0006;color:#fff
  }
  .qws-win .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  `,l=document.createElement("style");l.textContent=r,(document.documentElement||document.body).appendChild(l);let s=document.createElement("div");s.className="qws2",s.innerHTML=`
    <div class="row drag">
      <div class="title">QuinoaWS</div>
      <div class="sp"></div>
      <span id="qws2-status" class="pill warn mini">\u2026</span>
      <button id="qws2-min" class="btn" title="R\xE9duire/agrandir">\u2013</button>
      <button id="qws2-hide" class="btn" title="Masquer (Alt+X)">\u2715</button>
    </div>
    <div class="row" style="margin:6px 0 8px 0; align-items:flex-start">
      <div class="col">
        <span id="qws2-status2" class="pill warn">status: \u2026</span>
        <span id="qws2-store" class="pill warn">store: \u2026</span>
      </div>
      <span id="qws2-mode" class="pill" style="margin-left:auto">mode: auto</span>
    </div>
    <div class="body">
      <div id="qws-launch" class="qws-launch"></div>
    </div>
  `,(document.documentElement||document.body).appendChild(s);function f(o){let c=o.getBoundingClientRect(),y=window.innerWidth,d=window.innerHeight,g=parseFloat(getComputedStyle(o).right)||y-c.right,M=parseFloat(getComputedStyle(o).bottom)||d-c.bottom,x=Math.max(8,y-c.width-8),T=Math.max(8,d-c.height-8);g=Math.min(Math.max(g,8),x),M=Math.min(Math.max(M,8),T),o.style.right=g+"px",o.style.bottom=M+"px"}function S(o){f(o);let c=o.getBoundingClientRect(),d=o.querySelector(".w-head")?.getBoundingClientRect()||c,g=window.innerWidth,M=window.innerHeight,x=8,T=parseFloat(getComputedStyle(o).right);Number.isNaN(T)&&(T=g-c.right);let I=parseFloat(getComputedStyle(o).bottom);Number.isNaN(I)&&(I=M-c.bottom);let D=Math.max(x,g-c.width-x),R=Math.max(x,M-c.height-x);if(d.top<x){let b=x-d.top;I=Math.max(x,Math.min(R,I-b))}if(c.left<x){let b=x-c.left;T=Math.max(x,Math.min(D,T-b))}o.style.right=T+"px",o.style.bottom=I+"px"}function E(o){o.style.right="16px",o.style.bottom="16px",S(o)}function A(o,c){let y=o.getBoundingClientRect(),d=window.innerHeight,g=parseFloat(getComputedStyle(o).bottom);Number.isNaN(g)&&(g=d-y.bottom),c(),requestAnimationFrame(()=>{let M=o.getBoundingClientRect(),x=M.top-y.top,T=g+x,I=Math.max(8,d-M.height-8);T=Math.min(Math.max(8,T),I),o.style.bottom=T+"px",S(o)})}function N(){try{let o=parseFloat(s.style.right)||16,c=parseFloat(s.style.bottom)||16;localStorage.setItem(e,JSON.stringify({r:o,b:c}))}catch{}}try{let o=JSON.parse(localStorage.getItem(e)||"null");if(o&&typeof o.r=="number"&&typeof o.b=="number"&&(s.style.right=o.r+"px",s.style.bottom=o.b+"px"),localStorage.getItem(n)==="1"){s.classList.add("min");let c=s.querySelector("#qws2-min");c&&(c.textContent="+")}localStorage.getItem(a)==="1"&&s.classList.add("hidden"),requestAnimationFrame(()=>f(s)),window.addEventListener("resize",()=>f(s))}catch{}let K=s.querySelector(".drag"),L=s.querySelector("#qws2-min"),h=s.querySelector("#qws2-hide"),G=s.querySelector("#qws2-status"),F=s.querySelector("#qws2-status2"),O=s.querySelector("#qws2-store"),_=s.querySelector("#qws2-mode"),X=s.querySelector("#qws-launch");if(!K||!L||!h||!G||!F||!O||!_||!X){console.warn("[QuinoaWS] HUD elements missing, abort init");return}let ye=X;(function(){let c=0,y=0,d=0,g=0,M=!1;K.addEventListener("mousedown",x=>{M=!0,c=x.clientX,y=x.clientY;let T=s.getBoundingClientRect();d=parseFloat(getComputedStyle(s).right)||window.innerWidth-T.right,g=parseFloat(getComputedStyle(s).bottom)||window.innerHeight-T.bottom,document.body.style.userSelect="none"}),window.addEventListener("mousemove",x=>{if(!M)return;let T=x.clientX-c,I=x.clientY-y,D=d-T,R=g-I,b=s.getBoundingClientRect(),H=window.innerWidth,$=window.innerHeight,ne=Math.max(8,H-b.width-8),ce=Math.max(8,$-b.height-8);D=Math.min(Math.max(D,8),ne),R=Math.min(Math.max(R,8),ce),s.style.right=D+"px",s.style.bottom=R+"px"}),window.addEventListener("mouseup",()=>{M&&(M=!1,document.body.style.userSelect="",N())})})(),L.onclick=()=>{A(s,()=>{s.classList.toggle("min"),L.textContent=s.classList.contains("min")?"+":"\u2013";try{localStorage.setItem(n,s.classList.contains("min")?"1":"0")}catch{}})},h.onclick=()=>{s.classList.add("hidden");try{localStorage.setItem(a,"1")}catch{}},window.addEventListener("keydown",o=>{let c=(o.target&&o.target.tagName||"").toLowerCase();if(!(c==="input"||c==="textarea"||o.target?.isContentEditable)&&o.altKey&&!o.shiftKey&&!o.ctrlKey&&!o.metaKey&&(o.key==="x"||o.key==="X")){let d=s.classList.toggle("hidden");try{localStorage.setItem(a,d?"1":"0")}catch{}}},!0);let U=new Map,C=0;function me(o,c,y){if(U.has(o)){let R=U.get(o);R.el.style.display="",le(R.el),fe(o,!0);return}let d=document.createElement("div");d.className="qws-win",d.innerHTML=`
      <div class="w-head">
        <div class="w-title"></div>
        <div class="sp"></div>
        <button class="w-btn" data-act="min">\u2013</button>
        <button class="w-btn" data-act="close">\u2715</button>
      </div>
      <div class="w-body"></div>
    `,(document.documentElement||document.body).appendChild(d);let g=d.querySelector(".w-head"),M=d.querySelector(".w-title"),x=d.querySelector('[data-act="min"]'),T=d.querySelector('[data-act="close"]'),I=d.querySelector(".w-body");M.textContent=c;let D=C++%5*24;d.style.right=16+D+"px",d.style.bottom=16+D+"px",f(d),le(d),function(){let b=0,H=0,$=0,ne=0,ce=!1;g.addEventListener("mousedown",Q=>{if(Q.target.closest(".w-btn"))return;ce=!0,b=Q.clientX,H=Q.clientY;let Le=d.getBoundingClientRect();$=parseFloat(getComputedStyle(d).right)||window.innerWidth-Le.right,ne=parseFloat(getComputedStyle(d).bottom)||window.innerHeight-Le.bottom,document.body.style.userSelect="none",le(d)}),window.addEventListener("mousemove",Q=>{if(!ce)return;let ct=Q.clientX-b,Le=Q.clientY-H,Ye=$-ct,ze=ne-Le,ut=d.getBoundingClientRect(),Dt=window.innerWidth,Gt=window.innerHeight,_t=Math.max(8,Dt-ut.width-8),jt=Math.max(8,Gt-ut.height-8);Ye=Math.min(Math.max(Ye,8),_t),ze=Math.min(Math.max(ze,8),jt),d.style.right=Ye+"px",d.style.bottom=ze+"px"}),window.addEventListener("mouseup",()=>{ce=!1,document.body.style.userSelect="",we(o,d)})}(),x.onclick=()=>{A(d,()=>{let R=I.style.display==="none";I.style.display=R?"":"none",x.textContent=R?"\u2013":"+"})},T.onclick=()=>{d.style.display="none",fe(o,!1)},Te(d);try{y(I)}catch(R){I.textContent=String(R)}we(o,d),U.set(o,{id:o,el:d,head:g,body:I}),fe(o,!0)}function pe(o){return o.style.display!=="none"}function ge(o,c,y){let d=U.get(o);return d?pe(d.el)?(d.el.style.display="none",!1):(d.el.style.display="",le(d.el),S(d.el),!0):(me(o,c,g=>{let M=g.closest(".qws-win");M&&Ee(o,M),y(g)}),!0)}function le(o){let c=999999;U.forEach(y=>{let d=parseInt(getComputedStyle(y.el).zIndex||"999999",10);d>c&&(c=d)}),o.style.zIndex=String(c+1)}function we(o,c){try{let y=parseFloat(c.style.right)||16,d=parseFloat(c.style.bottom)||16;localStorage.setItem(`qws:win:${o}:pos`,JSON.stringify({r:y,b:d}))}catch{}}function Ee(o,c){try{let y=localStorage.getItem(`qws:win:${o}:pos`);if(!y)return;let d=JSON.parse(y);typeof d.r=="number"&&(c.style.right=d.r+"px"),typeof d.b=="number"&&(c.style.bottom=d.b+"px"),S(c)}catch{}}window.addEventListener("resize",()=>{U.forEach(o=>S(o.el))});function Re(){let o=null,c=T=>{let I=T;return I&&I.closest?.(".qws-win, .qws2")||null},y=T=>{if(!T.altKey||T.button!==0)return;let I=c(T.target);if(!I||I.style.display==="none")return;let D=I.getBoundingClientRect(),R=window.innerWidth,b=window.innerHeight,H=parseFloat(getComputedStyle(I).right),$=parseFloat(getComputedStyle(I).bottom);Number.isNaN(H)&&(H=R-D.right),Number.isNaN($)&&($=b-D.bottom),o={el:I,sx:T.clientX,sy:T.clientY,or:H,ob:$},document.body.style.userSelect="none",le(I),T.preventDefault(),T.stopPropagation()},d=T=>{if(!o)return;let I=T.clientX-o.sx,D=T.clientY-o.sy,R=o.or-I,b=o.ob-D,H=o.el.getBoundingClientRect(),$=window.innerWidth,ne=window.innerHeight,ce=Math.max(8,$-H.width-8),Q=Math.max(8,ne-H.height-8);R=Math.min(Math.max(R,8),ce),b=Math.min(Math.max(b,8),Q),o.el.style.right=`${R}px`,o.el.style.bottom=`${b}px`},g=()=>{if(!o)return;document.body.style.userSelect="",f(o.el);let T=o.el,I=!1;U.forEach(D=>{D.el===T&&!I&&(we(D.id,T),I=!0)}),!I&&T===s&&N(),o=null},M=()=>g(),x=T=>{(T.key==="Alt"||T.key==="AltGraph")&&g()};window.addEventListener("mousedown",y,!0),window.addEventListener("mousemove",d,!0),window.addEventListener("mouseup",M,!0),window.addEventListener("keyup",x,!0)}function Te(o){let c=b=>{if(!b||!(b instanceof HTMLElement))return!1;let H=b.tagName.toLowerCase();return H==="input"||H==="textarea"||b.isContentEditable},y=b=>b.length===1?/\p{L}|\p{Nd}/u.test(b):!!/^Numpad[0-9]$/.test(b),d=new Set(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","Tab","Enter","NumpadEnter"]),g=b=>(b.stopPropagation(),b.stopImmediatePropagation?.(),b.cancelBubble=!0,!1),M=b=>(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation?.(),b.cancelBubble=!0,b.returnValue=!1,!1),x=b=>{let H=document.activeElement,$=b.target,ne=Q=>!!(Q&&(o.contains(Q)||Q.closest?.(".qws-win")||Q.closest?.(".qws2")));if(!(!(ne($)||ne(H))||!(y(b.key)||d.has(b.key))))return c($)||c(H)?g(b):M(b)},T=["keydown","keypress","keyup"],I=(b,H)=>{window.addEventListener(b,x,H),document.addEventListener(b,x,H),o.addEventListener(b,x,H)};T.forEach(b=>{I(b,{capture:!0}),I(b,!1)});let D=b=>{T.forEach(H=>{b.addEventListener(H,x,{capture:!0}),b.addEventListener(H,x,!1)})};o.querySelectorAll("input,textarea,[contenteditable]").forEach(D);let R=new MutationObserver(b=>{for(let H of b)for(let $ of Array.from(H.addedNodes))$ instanceof HTMLElement&&($.matches?.("input,textarea,[contenteditable]")&&D($),$.querySelectorAll?.("input,textarea,[contenteditable]").forEach(ne=>D(ne)))});return R.observe(o,{childList:!0,subtree:!0}),()=>{T.forEach(b=>{window.removeEventListener(b,x,{capture:!0}),window.removeEventListener(b,x,!1),document.removeEventListener(b,x,{capture:!0}),document.removeEventListener(b,x,!1),o.removeEventListener(b,x,{capture:!0}),o.removeEventListener(b,x,!1)}),R.disconnect()}}let Ae=[],xe=new Map;function fe(o,c){let y=xe.get(o);y&&(y.textContent=c?"Masquer":"Ouvrir",y.dataset.open=c?"1":"0",c?y.classList.add("active"):y.classList.remove("active"))}function ve(o,c,y){Ae.push({id:o,title:c,render:y}),u(o,c,y)}function u(o,c,y){let d=document.createElement("div");d.className="launch-item",d.innerHTML=`<div class="name">${w(c)}</div>`;let g=document.createElement("button");g.className="btn",g.textContent="Ouvrir",g.dataset.open="0",xe.set(o,g),g.onclick=()=>{let M=U.get(o);M&&M.el.style.display!=="none"?(M.el.style.display="none",fe(o,!1)):(me(o,c,x=>{let T=x.closest(".qws-win");T&&Ee(o,T),y(x)}),fe(o,!0))},d.appendChild(g),ye.appendChild(d)}try{t?.onRegister?.(ve)}catch{}Te(s),Re(),(async()=>{try{await z()}catch{}})(),setInterval(()=>{try{let o=p();G.textContent="OPEN",F.textContent="status: OPEN",m(G,"ok"),m(F,"ok"),_.textContent="mode: page"}catch{let o=!!window.__QWS_workerFound||qe;G.textContent=o?"Worker":"none",F.textContent="status: "+(o?"via Worker":"none"),m(G,o?"ok":"warn"),m(F,o?"ok":"warn"),_.textContent="mode: "+(o?"worker":"auto")}try{let o=Se(),c=Ze();o?(O.textContent=`store: ${c.via||"ready"}`,m(O,"ok")):c.via==="polyfill"||c.polyfill?(O.textContent="store: polyfill",m(O,"warn")):(O.textContent="store: none",m(O,"bad"))}catch{O.textContent="store: error",m(O,"bad")}},800);function p(){for(let o=0;o<Z.length;o++)if(Z[o].readyState===J.OPEN)return Z[o];throw new Error("no page ws")}function m(o,c){o.classList.remove("ok","warn","bad"),c&&o.classList.add(c)}function w(o){return o.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[c])}}function cn(t){if(ae.forEach)ae.forEach(e=>{try{e.postMessage(t)}catch{}});else for(let e of ae._a)try{e.postMessage(t)}catch{}}function un(){if(be&&be.readyState===J.OPEN)return be;let t=null;if(Z.find&&(t=Z.find(e=>e.readyState===J.OPEN)||null),!t){for(let e=0;e<Z.length;e++)if(Z[e].readyState===J.OPEN){t=Z[e];break}}if(t)return he(t,"getPageWS"),t;throw new Error("No page WebSocket open")}function te(t){let e={scopePath:["Room","Quinoa"],...t};try{return un().send(JSON.stringify(e)),!0}catch{return cn({__QWS_CMD:"send",payload:JSON.stringify(e)}),!0}}var v={Common:"Common",Uncommon:"Uncommon",Rare:"Rare",Legendary:"Legendary",Mythic:"Mythical",Divine:"Divine",Celestial:"Celestial"},k={Single:"Single",Multiple:"Multiple"};var P={Empty:0,DirtPatch:1,SproutFlower:2,SproutVegetable:3,SproutFruit:4,SproutVine:5,StemFlower:6,Trellis:7,Daffodil:11,Tulip:12,Sunflower:13,Lily:14,Starweaver:15,StarweaverPlant:16,AloePlant:17,Aloe:18,Blueberry:21,Banana:22,Strawberry:23,Mango:24,Grape:25,Watermelon:26,Lemon:27,Apple:28,Pepper:31,Tomato:32,BabyCarrot:33,Carrot:34,Pumpkin:35,Corn:36,PalmTreeTop:39,BushyTree:40,Coconut:41,MushroomPlant:42,PassionFruit:43,DragonFruit:44,Lychee:45,Mushroom:46,BurrosTail:47,Cacao:48,Echeveria:49},ue={Empty:0,Bamboo:1,PalmTree:2,Cactus:3,Tree:4},B={Empty:0,Daffodil:1,Tulip:2,Sunflower:3,Starweaver:6,Blueberry:11,Banana:12,Strawberry:13,Mango:14,Grape:15,Watermelon:16,Lemon:17,Apple:18,Lily:20,Pepper:21,Tomato:22,Carrot:23,Pumpkin:25,Corn:26,Bamboo:41,Coconut:31,Mushroom:32,PassionFruit:33,DragonFruit:34,Lychee:35,BurrosTail:37,Aloe:39,Echeveria:40,Cactus:42},_e={Empty:0,Coin:1,Shovel:2,Seeds:3,PlanterPot:5,InventoryBag:6,WateringCan:14,Fertilizer:15,RainbowPotion:16,ArrowKeys:41,Touchpad:42};var Y={Bee:1,Chicken:2,Bunny:3,Turtle:4,Capybara:5,Cow:6,Pig:7,Butterfly:8,Snail:9,Worm:10,CommonEgg:11,UncommonEgg:12,RareEgg:13,LegendaryEgg:14,MythicalEgg:15,DivineEgg:16,CelestialEgg:17,Squirrel:18,Goat:19},Me={Wet:1,Chilled:2,Frozen:3,Dawnlit:11,Ambershine:12},je={Carrot:{seed:{tileRef:B.Carrot,name:"Carrot Seed",coinPrice:10,creditPrice:7,rarity:v.Common},plant:{tileRef:P.BabyCarrot,name:"Carrot Plant",harvestType:k.Single,baseTileScale:.7},crop:{tileRef:P.Carrot,name:"Carrot",baseSellPrice:20,baseWeight:.1,baseTileScale:.6,maxScale:3}},Strawberry:{seed:{tileRef:B.Strawberry,name:"Strawberry Seed",coinPrice:50,creditPrice:21,rarity:v.Common},plant:{tileRef:P.SproutFruit,name:"Strawberry Plant",harvestType:k.Multiple,slotOffsets:[{x:.3,y:.4,rotation:85},{x:.675,y:.3,rotation:195},{x:.32,y:.72,rotation:340},{x:.7,y:.7,rotation:280},{x:.51,y:.51,rotation:0}],secondsToMature:70,baseTileScale:1,rotateSlotOffsetsRandomly:!0},crop:{tileRef:P.Strawberry,name:"Strawberry",baseSellPrice:14,baseWeight:.05,baseTileScale:.25,maxScale:2}},Aloe:{seed:{tileRef:B.Aloe,name:"Aloe Seed",coinPrice:135,creditPrice:18,rarity:v.Common},plant:{tileRef:P.AloePlant,name:"Aloe Plant",harvestType:k.Single,baseTileScale:.9},crop:{tileRef:P.Aloe,name:"Aloe",baseSellPrice:310,baseWeight:1.5,baseTileScale:.7,maxScale:2.5}},Blueberry:{seed:{tileRef:B.Blueberry,name:"Blueberry Seed",coinPrice:400,creditPrice:49,rarity:v.Uncommon},plant:{tileRef:P.SproutFruit,name:"Blueberry Plant",harvestType:k.Multiple,slotOffsets:[{x:.3,y:.4,rotation:85},{x:.675,y:.3,rotation:195},{x:.32,y:.72,rotation:340},{x:.7,y:.7,rotation:280},{x:.51,y:.51,rotation:0}],secondsToMature:105,baseTileScale:1,rotateSlotOffsetsRandomly:!0},crop:{tileRef:P.Blueberry,name:"Blueberry",baseSellPrice:23,baseWeight:.01,baseTileScale:.25,maxScale:2}},Apple:{seed:{tileRef:B.Apple,name:"Apple Seed",coinPrice:500,creditPrice:67,rarity:v.Uncommon,unavailableSurfaces:["discord"]},plant:{tileRef:ue.Tree,name:"Apple Tree",harvestType:k.Multiple,slotOffsets:[{x:.15,y:-1.9,rotation:-90},{x:0,y:-1.5,rotation:-75},{x:.6,y:-1.7,rotation:-60},{x:.3,y:-1.15,rotation:-55},{x:1.05,y:-1.4,rotation:-45},{x:.8,y:-1.2,rotation:-35},{x:.9,y:.6,rotation:-30}],secondsToMature:360*60,baseTileScale:3,rotateSlotOffsetsRandomly:!1,tileTransformOrigin:"bottom",nudgeY:.25},crop:{tileRef:P.Apple,name:"Apple",baseSellPrice:73,baseWeight:.18,baseTileScale:.5,maxScale:2}},OrangeTulip:{seed:{tileRef:B.Tulip,name:"Tulip Seed",coinPrice:600,creditPrice:14,rarity:v.Uncommon},plant:{tileRef:P.Tulip,name:"Tulip Plant",harvestType:k.Single,baseTileScale:.5},crop:{tileRef:P.Tulip,name:"Tulip",baseSellPrice:767,baseWeight:.01,baseTileScale:.5,maxScale:3}},Tomato:{seed:{tileRef:B.Tomato,name:"Tomato Seed",coinPrice:800,creditPrice:79,rarity:v.Uncommon},plant:{tileRef:P.SproutVine,name:"Tomato Plant",harvestType:k.Multiple,slotOffsets:[{x:.2,y:.2,rotation:0},{x:.8,y:.8,rotation:0}],secondsToMature:1100,baseTileScale:1,rotateSlotOffsetsRandomly:!1},crop:{tileRef:P.Tomato,name:"Tomato",baseSellPrice:27,baseWeight:.3,baseTileScale:.33,maxScale:2}},Daffodil:{seed:{tileRef:B.Daffodil,name:"Daffodil Seed",coinPrice:1e3,creditPrice:19,rarity:v.Rare},plant:{tileRef:P.Daffodil,name:"Daffodil Plant",harvestType:k.Single,baseTileScale:.5},crop:{tileRef:P.Daffodil,name:"Daffodil",baseSellPrice:1090,baseWeight:.01,baseTileScale:.5,maxScale:3}},Corn:{seed:{tileRef:B.Corn,name:"Corn Kernel",coinPrice:1300,creditPrice:135,rarity:v.Rare},plant:{tileRef:P.SproutVegetable,name:"Corn Plant",harvestType:k.Multiple,slotOffsets:[{x:.5,y:.4,rotation:0}],secondsToMature:130,baseTileScale:1,rotateSlotOffsetsRandomly:!1},crop:{tileRef:P.Corn,name:"Corn",baseSellPrice:36,baseWeight:1.2,baseTileScale:.7,maxScale:2}},Watermelon:{seed:{tileRef:B.Watermelon,name:"Watermelon Seed",coinPrice:2500,creditPrice:195,rarity:v.Rare},plant:{tileRef:P.Watermelon,name:"Watermelon Plant",harvestType:k.Single,baseTileScale:.8},crop:{tileRef:P.Watermelon,name:"Watermelon",baseSellPrice:2708,baseWeight:4.5,baseTileScale:.8,maxScale:3}},Pumpkin:{seed:{tileRef:B.Pumpkin,name:"Pumpkin Seed",coinPrice:3e3,creditPrice:210,rarity:v.Rare},plant:{tileRef:P.Pumpkin,name:"Pumpkin Plant",harvestType:k.Single,baseTileScale:.8},crop:{tileRef:P.Pumpkin,name:"Pumpkin",baseSellPrice:3700,baseWeight:6,baseTileScale:.8,maxScale:3}},Echeveria:{seed:{tileRef:B.Echeveria,name:"Echeveria Cutting",coinPrice:4200,creditPrice:113,rarity:v.Legendary},plant:{tileRef:P.Echeveria,name:"Echeveria Plant",harvestType:k.Single,baseTileScale:.8},crop:{tileRef:P.Echeveria,name:"Echeveria",baseSellPrice:4600,baseWeight:.8,baseTileScale:.8,maxScale:2.75}},Coconut:{seed:{tileRef:B.Coconut,name:"Coconut Seed",coinPrice:6e3,creditPrice:235,rarity:v.Legendary},plant:{tileRef:ue.PalmTree,name:"Coconut Tree",harvestType:k.Multiple,slotOffsets:[{x:.3,y:-2.1,rotation:0},{x:.2,y:-1.9,rotation:51.4},{x:.7,y:-2,rotation:102.9},{x:.25,y:-1.6,rotation:154.3},{x:.5,y:-1.8,rotation:205.7},{x:.8,y:-1.7,rotation:257.1},{x:.55,y:-1.5,rotation:308.6}],secondsToMature:720*60,baseTileScale:3,rotateSlotOffsetsRandomly:!0,tileTransformOrigin:"bottom",nudgeY:.15},crop:{tileRef:P.Coconut,name:"Coconut",baseSellPrice:302,baseWeight:5,baseTileScale:.25,maxScale:3}},Banana:{seed:{tileRef:B.Banana,name:"Banana Seed",coinPrice:7500,creditPrice:199,rarity:v.Legendary,getCanSpawnInGuild:t=>{let e=t.slice(-1),n=parseInt(e,10);return!isNaN(n)&&n%2===0}},plant:{tileRef:ue.PalmTree,name:"Banana Plant",harvestType:k.Multiple,slotOffsets:[{x:.2,y:-1.2,rotation:10},{x:.3,y:-1.2,rotation:-10},{x:.4,y:-1.2,rotation:-30},{x:.5,y:-1.2,rotation:-50},{x:.6,y:-1.2,rotation:-70}],secondsToMature:14400,baseTileScale:2.5,rotateSlotOffsetsRandomly:!1,tileTransformOrigin:"bottom",nudgeY:.1},crop:{tileRef:P.Banana,name:"Banana",baseSellPrice:1750,baseWeight:.12,baseTileScale:.5,maxScale:1.7}},Lily:{seed:{tileRef:B.Lily,name:"Lily Seed",coinPrice:2e4,creditPrice:34,rarity:v.Legendary},plant:{tileRef:P.Lily,name:"Lily Plant",harvestType:k.Single,baseTileScale:.75,nudgeY:.4},crop:{tileRef:P.Lily,name:"Lily",baseSellPrice:20123,baseWeight:.02,baseTileScale:.5,maxScale:2.75}},BurrosTail:{seed:{tileRef:B.BurrosTail,name:"Burro's Tail Cutting",coinPrice:93e3,creditPrice:338,rarity:v.Legendary},plant:{tileRef:P.Trellis,name:"Burro's Tail Plant",harvestType:k.Multiple,slotOffsets:[{x:.37,y:.4,rotation:0},{x:.67,y:.63,rotation:0}],secondsToMature:1800,baseTileScale:.8,rotateSlotOffsetsRandomly:!1},crop:{tileRef:P.BurrosTail,name:"Burro's Tail",baseSellPrice:6e3,baseWeight:.4,baseTileScale:.4,maxScale:2.5}},Mushroom:{seed:{tileRef:B.Mushroom,name:"Mushroom Spore",coinPrice:15e4,creditPrice:249,rarity:v.Mythic},plant:{tileRef:P.MushroomPlant,name:"Mushroom Plant",harvestType:k.Single,baseTileScale:.8},crop:{tileRef:P.Mushroom,name:"Mushroom",baseSellPrice:16e4,baseWeight:25,baseTileScale:.8,maxScale:3.5}},Cactus:{seed:{tileRef:B.Cactus,name:"Cactus Seed",coinPrice:25e4,creditPrice:250,rarity:v.Mythic},plant:{tileRef:ue.Cactus,name:"Cactus Plant",harvestType:k.Single,baseTileScale:2.5,tileTransformOrigin:"bottom",nudgeY:.15},crop:{tileRef:ue.Cactus,name:"Cactus",baseSellPrice:261e3,baseWeight:1500,baseTileScale:2.5,maxScale:1.8}},Bamboo:{seed:{tileRef:B.Bamboo,name:"Bamboo Seed",coinPrice:4e5,creditPrice:300,rarity:v.Mythic},plant:{tileRef:ue.Bamboo,name:"Bamboo Plant",harvestType:k.Single,baseTileScale:2.5,tileTransformOrigin:"bottom",nudgeY:.1},crop:{tileRef:ue.Bamboo,name:"Bamboo Shoot",baseSellPrice:5e5,baseWeight:1,baseTileScale:2.5,maxScale:2}},Grape:{seed:{tileRef:B.Grape,name:"Grape Seed",coinPrice:85e4,creditPrice:599,rarity:v.Mythic,getCanSpawnInGuild:t=>t.endsWith("1")},plant:{tileRef:P.SproutVine,name:"Grape Plant",harvestType:k.Multiple,slotOffsets:[{x:.5,y:.5,rotation:0}],secondsToMature:1440*60,baseTileScale:1,rotateSlotOffsetsRandomly:!1},crop:{tileRef:P.Grape,name:"Grape",baseSellPrice:7085,baseWeight:3,baseTileScale:.5,maxScale:2}},Pepper:{seed:{tileRef:B.Pepper,name:"Pepper Seed",coinPrice:1e6,creditPrice:629,rarity:v.Divine},plant:{tileRef:P.SproutVine,name:"Pepper Plant",harvestType:k.Multiple,slotOffsets:[{x:.1,y:.1,rotation:0},{x:.9,y:.1,rotation:0},{x:.3,y:.3,rotation:0},{x:.7,y:.3,rotation:0},{x:.5,y:.5,rotation:0},{x:.3,y:.7,rotation:0},{x:.7,y:.7,rotation:0},{x:.1,y:.9,rotation:0},{x:.9,y:.9,rotation:0}],secondsToMature:560,baseTileScale:1,rotateSlotOffsetsRandomly:!0},crop:{tileRef:P.Pepper,name:"Pepper",baseSellPrice:7220,baseWeight:.5,baseTileScale:.3,maxScale:2}},Lemon:{seed:{tileRef:B.Lemon,name:"Lemon Seed",coinPrice:2e6,creditPrice:500,rarity:v.Divine,getCanSpawnInGuild:t=>t.endsWith("2")},plant:{tileRef:ue.Tree,name:"Lemon Tree",harvestType:k.Multiple,slotOffsets:[{x:0,y:-1,rotation:85},{x:.9,y:-1.1,rotation:195},{x:.2,y:-.68,rotation:340},{x:.7,y:-.7,rotation:280},{x:.51,y:-1,rotation:0},{x:.45,y:-1.3,rotation:280}],secondsToMature:720*60,baseTileScale:2.3,rotateSlotOffsetsRandomly:!0,tileTransformOrigin:"bottom",nudgeY:.25},crop:{tileRef:P.Lemon,name:"Lemon",baseSellPrice:1e4,baseWeight:.5,baseTileScale:.25,maxScale:3}},PassionFruit:{seed:{tileRef:B.PassionFruit,name:"Passion Fruit Seed",coinPrice:275e4,creditPrice:679,rarity:v.Divine},plant:{tileRef:P.SproutVine,name:"Passion Fruit Plant",harvestType:k.Multiple,slotOffsets:[{x:.2,y:.2,rotation:0},{x:.8,y:.8,rotation:0}],secondsToMature:1440*60,baseTileScale:1.1,rotateSlotOffsetsRandomly:!1},crop:{tileRef:P.PassionFruit,name:"Passion Fruit",baseSellPrice:24500,baseWeight:9.5,baseTileScale:.35,maxScale:2}},DragonFruit:{seed:{tileRef:B.DragonFruit,name:"Dragon Fruit Seed",coinPrice:5e6,creditPrice:715,rarity:v.Divine},plant:{tileRef:P.PalmTreeTop,name:"Dragon Fruit Plant",harvestType:k.Multiple,slotOffsets:[{x:.2,y:.1,rotation:0},{x:.1,y:.45,rotation:51.4},{x:.86,y:.2,rotation:102.9},{x:.25,y:.8,rotation:154.3},{x:.5,y:.4,rotation:205.7},{x:.9,y:.6,rotation:257.1},{x:.6,y:.7,rotation:308.6}],secondsToMature:600,baseTileScale:1.6,rotateSlotOffsetsRandomly:!0},crop:{tileRef:P.DragonFruit,name:"Dragon Fruit",baseSellPrice:24500,baseWeight:8.4,baseTileScale:.4,maxScale:2}},Lychee:{seed:{tileRef:B.Lychee,name:"Lychee Pit",coinPrice:25e6,creditPrice:819,rarity:v.Divine,getCanSpawnInGuild:t=>t.endsWith("2")},plant:{tileRef:P.BushyTree,name:"Lychee Plant",harvestType:k.Multiple,slotOffsets:[{x:.1,y:.4,rotation:85},{x:.8,y:.3,rotation:195},{x:.2,y:.72,rotation:340},{x:.7,y:.7,rotation:280},{x:.51,y:.4,rotation:0},{x:.3,y:.2,rotation:280}],secondsToMature:1440*60,baseTileScale:1.2,rotateSlotOffsetsRandomly:!0},crop:{tileRef:P.Lychee,name:"Lychee Fruit",baseSellPrice:5e4,baseWeight:9,baseTileScale:.2,maxScale:2}},Sunflower:{seed:{tileRef:B.Sunflower,name:"Sunflower Seed",coinPrice:1e8,creditPrice:900,rarity:v.Divine},plant:{tileRef:P.StemFlower,name:"Sunflower Plant",harvestType:k.Multiple,slotOffsets:[{x:.51,y:-.1,rotation:0}],secondsToMature:1440*60,rotateSlotOffsetsRandomly:!0,tileTransformOrigin:"bottom",baseTileScale:.8,nudgeY:.15},crop:{tileRef:P.Sunflower,name:"Sunflower",baseSellPrice:75e4,baseWeight:10,baseTileScale:.5,maxScale:2.5}},Starweaver:{seed:{tileRef:B.Starweaver,name:"Starweaver Pod",coinPrice:1e9,creditPrice:1e3,rarity:v.Celestial},plant:{tileRef:P.StarweaverPlant,name:"Starweaver Plant",harvestType:k.Multiple,slotOffsets:[{x:.5,y:-.158,rotation:0}],secondsToMature:1440*60,baseTileScale:1.5,rotateSlotOffsetsRandomly:!1,nudgeY:.25},crop:{tileRef:P.Starweaver,name:"Starweaver Fruit",baseSellPrice:1e7,baseWeight:10,baseTileScale:.6,maxScale:2}}},jn={Gold:{name:"Gold",baseChance:.01,coinMultiplier:25},Rainbow:{name:"Rainbow",baseChance:.001,coinMultiplier:50},Wet:{name:"Wet",baseChance:0,coinMultiplier:2,tileRef:Me.Wet},Chilled:{name:"Chilled",baseChance:0,coinMultiplier:2,tileRef:Me.Chilled},Frozen:{name:"Frozen",baseChance:0,coinMultiplier:10,tileRef:Me.Frozen},Dawnlit:{name:"Dawnlit",baseChance:0,coinMultiplier:2,tileRef:Me.Dawnlit},Ambershine:{name:"Ambershine",baseChance:0,coinMultiplier:5,tileRef:Me.Ambershine}},Ke={CommonEgg:{tileRef:Y.CommonEgg,name:"Common Egg",coinPrice:1e5,creditPrice:19,rarity:v.Common,initialTileScale:.3,baseTileScale:.8,secondsToHatch:600,faunaSpawnWeights:{Worm:60,Snail:35,Bee:5}},UncommonEgg:{tileRef:Y.UncommonEgg,name:"Uncommon Egg",coinPrice:1e6,creditPrice:48,rarity:v.Uncommon,initialTileScale:.3,baseTileScale:.8,secondsToHatch:3600,faunaSpawnWeights:{Chicken:75,Bunny:25}},RareEgg:{tileRef:Y.RareEgg,name:"Rare Egg",coinPrice:1e7,creditPrice:99,rarity:v.Rare,initialTileScale:.3,baseTileScale:.8,secondsToHatch:21600,faunaSpawnWeights:{Pig:90,Cow:10}},LegendaryEgg:{tileRef:Y.LegendaryEgg,name:"Legendary Egg",coinPrice:1e8,creditPrice:249,rarity:v.Legendary,initialTileScale:.3,baseTileScale:.8,secondsToHatch:43200,faunaSpawnWeights:{Squirrel:60,Turtle:30,Goat:10}},MythicalEgg:{tileRef:Y.MythicalEgg,name:"Mythical Egg",coinPrice:1e9,creditPrice:599,rarity:v.Mythic,initialTileScale:.3,baseTileScale:.8,secondsToHatch:86400,faunaSpawnWeights:{Butterfly:95,Capybara:5}}},Kn={Worm:{tileRef:Y.Worm,name:"Worm",description:"",coinsToFullyReplenishHunger:500,innateAbilityWeights:{SeedFinderI:50,ProduceEater:50},baseTileScale:.6,maxScale:2,maturitySellPrice:5e3,matureWeight:.1,moveProbability:.1,hoursToMature:12,rarity:v.Common,tileTransformOrigin:"bottom",nudgeY:.25,diet:["Carrot","Strawberry","Aloe","Tomato","Apple"]},Snail:{tileRef:Y.Snail,name:"Snail",description:"",coinsToFullyReplenishHunger:1e3,innateAbilityWeights:{CoinFinderI:100},baseTileScale:.6,maxScale:2,maturitySellPrice:5e3,matureWeight:.15,moveProbability:.01,hoursToMature:12,rarity:v.Common,tileTransformOrigin:"bottom",diet:["Blueberry","Tomato","Corn","Daffodil"],nudgeY:.25},Bee:{tileRef:Y.Bee,name:"Bee",description:"",coinsToFullyReplenishHunger:1500,innateAbilityWeights:{ProduceScaleBoost:50,ProduceMutationBoost:50},baseTileScale:.6,maxScale:2.5,maturitySellPrice:5e3,matureWeight:.2,moveProbability:.5,hoursToMature:12,rarity:v.Common,diet:["Strawberry","Blueberry","OrangeTulip","Daffodil","Lily"]},Chicken:{tileRef:Y.Chicken,name:"Chicken",description:"",coinsToFullyReplenishHunger:3e3,innateAbilityWeights:{EggGrowthBoost:80,PetRefund:20},baseTileScale:.8,maxScale:2,maturitySellPrice:25e3,matureWeight:3,moveProbability:.2,hoursToMature:24,rarity:v.Uncommon,tileTransformOrigin:"bottom",nudgeY:.3,diet:["Aloe","Corn","Watermelon","Pumpkin"]},Bunny:{tileRef:Y.Bunny,name:"Bunny",description:"",coinsToFullyReplenishHunger:750,innateAbilityWeights:{CoinFinderII:60,SellBoostI:40},baseTileScale:.7,maxScale:2,maturitySellPrice:25e3,matureWeight:2,moveProbability:.3,hoursToMature:24,rarity:v.Uncommon,tileTransformOrigin:"bottom",nudgeY:.3,diet:["Carrot","Strawberry","Blueberry","Echeveria"]},Pig:{tileRef:Y.Pig,name:"Pig",description:"",coinsToFullyReplenishHunger:5e4,innateAbilityWeights:{SellBoostII:30,PetAgeBoost:30,PetHatchSizeBoost:30},baseTileScale:1,maxScale:2.5,maturitySellPrice:1e5,matureWeight:200,moveProbability:.2,hoursToMature:72,rarity:v.Rare,tileTransformOrigin:"bottom",nudgeY:.35,diet:["Watermelon","Pumpkin","Mushroom","Bamboo"]},Cow:{tileRef:Y.Cow,name:"Cow",description:"",coinsToFullyReplenishHunger:25e3,innateAbilityWeights:{SeedFinderII:30,HungerBoost:30,PlantGrowthBoost:30},baseTileScale:1.1,maxScale:2.5,maturitySellPrice:1e5,matureWeight:600,moveProbability:.1,hoursToMature:72,rarity:v.Rare,tileTransformOrigin:"bottom",nudgeY:.35,diet:["Coconut","Banana","BurrosTail","Mushroom"]},Squirrel:{tileRef:Y.Squirrel,name:"Squirrel",description:"",coinsToFullyReplenishHunger:15e3,innateAbilityWeights:{CoinFinderIII:70,SellBoostIII:20,PetMutationBoost:10},baseTileScale:.6,maxScale:2,maturitySellPrice:3e6,matureWeight:.5,moveProbability:.4,hoursToMature:100,rarity:v.Legendary,tileTransformOrigin:"bottom",nudgeY:.4,diet:["Pumpkin","Banana","Grape"]},Turtle:{tileRef:Y.Turtle,name:"Turtle",description:"",coinsToFullyReplenishHunger:1e5,innateAbilityWeights:{HungerRestore:25,HungerBoostII:25,PlantGrowthBoostII:25,EggGrowthBoostII:25},baseTileScale:1,maxScale:2.5,maturitySellPrice:5e6,matureWeight:150,moveProbability:.05,hoursToMature:100,rarity:v.Legendary,tileTransformOrigin:"bottom",nudgeY:.35,diet:["Watermelon","BurrosTail","Bamboo","Pepper"]},Goat:{tileRef:Y.Goat,name:"Goat",description:"",coinsToFullyReplenishHunger:2e4,innateAbilityWeights:{PetHatchSizeBoostII:10,PetAgeBoostII:40,PetXpBoost:40},baseTileScale:1,maxScale:2,maturitySellPrice:1e7,matureWeight:100,moveProbability:.2,hoursToMature:100,rarity:v.Legendary,tileTransformOrigin:"bottom",nudgeY:.4,diet:["Pumpkin","Coconut","Cactus","Pepper"]},Butterfly:{tileRef:Y.Butterfly,name:"Butterfly",description:"",coinsToFullyReplenishHunger:25e3,innateAbilityWeights:{ProduceScaleBoostII:40,ProduceMutationBoostII:40,SeedFinderIII:20},baseTileScale:.6,maxScale:2.5,maturitySellPrice:25e6,matureWeight:.2,moveProbability:.6,hoursToMature:144,rarity:v.Mythic,tileTransformOrigin:"center",diet:["Daffodil","Lily","Grape","Lemon","Sunflower"]},Capybara:{tileRef:Y.Capybara,name:"Capybara",description:"",coinsToFullyReplenishHunger:15e4,innateAbilityWeights:{DoubleHarvest:50,ProduceRefund:50},baseTileScale:1,maxScale:2.5,maturitySellPrice:1e8,matureWeight:50,moveProbability:.2,hoursToMature:144,rarity:v.Mythic,tileTransformOrigin:"bottom",nudgeY:.4,diet:["Lemon","PassionFruit","DragonFruit","Lychee"]}};var $e={WateringCan:{tileRef:_e.WateringCan,name:"Watering Can",coinPrice:5e3,creditPrice:2,rarity:v.Common,description:"Speeds up growth of plant by 5 minutes. SINGLE USE.",isOneTimePurchase:!1,baseTileScale:.6,maxInventoryQuantity:99},PlanterPot:{tileRef:_e.PlanterPot,name:"Planter Pot",coinPrice:25e3,creditPrice:5,rarity:v.Common,description:"Extract a plant to your inventory (can be replanted). SINGLE USE.",isOneTimePurchase:!1,baseTileScale:.8},Shovel:{tileRef:_e.Shovel,name:"Shovel",coinPrice:1e6,creditPrice:100,rarity:v.Uncommon,description:"Remove plants from your garden. UNLIMITED USES.",isOneTimePurchase:!0,baseTileScale:.7},RainbowPotion:{tileRef:_e.RainbowPotion,name:"Rainbow Potion",coinPrice:1/0,creditPrice:1/0,rarity:v.Celestial,description:"Adds the Rainbow mutation to a crop in your garden. SINGLE USE.",isOneTimePurchase:!0,baseTileScale:1}};var dn="menu:shops:auto",ot=t=>{let e=typeof t=="number"?t:Number(t);if(!isFinite(e))return e===1/0?"\u221E":null;let n=Math.abs(e),a=i=>i%1===0?String(i):i.toFixed(1);return n>=1e12?`${a(e/1e12)}T`:n>=1e9?`${a(e/1e9)}B`:n>=1e6?`${a(e/1e6)}M`:n>=1e3?`${a(e/1e3)}k`:String(e)};function mn(t){return t&&typeof t=="object"&&"species"in t}function pn(t){return t&&typeof t=="object"&&"toolId"in t}function fn(t){return t&&typeof t=="object"&&"eggId"in t}function yn(t){if(!t||typeof t!="object")return null;if(typeof t.secondsUntilRestock=="number")return t.secondsUntilRestock;for(let e of Object.keys(t)){let n=t[e];if(typeof n=="number"&&e.toLowerCase().includes("secondsuntilrestock"))return n}return null}function rt(t,e){let n=new Set,a=[t];for(;a.length;){let i=a.pop();if(!(!i||typeof i!="object"||n.has(i))){n.add(i);for(let r of Object.keys(i)){let l=i[r];if(Array.isArray(l)&&l.length&&l.every(s=>typeof s=="object")&&l.some(e)){let s=yn(i);return{items:l,sec:s}}}for(let r of Object.keys(i)){let l=i[r];l&&typeof l=="object"&&a.push(l)}}}return{items:[],sec:null}}function Mt(t){let e=t.initialStock??t.qty??t.quantity??t.remaining??t.stock;return typeof e=="number"?e:e==null?"":Number(e)||0}function it(t,e){return t==="seeds"?`seeds:${e.species??e.name??"Unknown"}`:t==="tools"?`tools:${e.toolId??e.id??e.name??"Unknown"}`:`eggs:${e.eggId??e.id??e.name??"Unknown"}`}function st(t,e){let n=it(t,e),a=e.price??e.cost??e.amount??"",i=Mt(e);return`${n}@${a}#${i}`}function gn(t){let e=t.indexOf(":");return e>=0?t.slice(e+1):t}function bn(){try{let t=localStorage.getItem(dn);if(t)return new Set(JSON.parse(t))}catch{}return new Set}async function hn(){let t=q("shopsAtom");if(!t)return{};try{let e=await j(t),n=a=>{if(Array.isArray(a))return a.map(n);if(!a||typeof a!="object")return a;if((a.itemType==="Seed"||"species"in a)&&typeof a.species=="string"){let r=a.species,l=je?.[r],s=l?.seed?.coinPrice??a.price??a.cost??a.amount??null,f=l?.seed?.name??l?.name??r;return{...a,name:f,price:s,priceFmt:s!=null?ot(s):null}}if((a.itemType==="Tool"||"toolId"in a)&&a.toolId!=null){let r=String(a.toolId),l=$e?.[r],s=l?.coinPrice??a.price??a.cost??a.amount??null,f=l?.name??r;return{...a,name:f,price:s,priceFmt:s!=null?ot(s):null}}if((a.itemType==="Egg"||"eggId"in a)&&a.eggId!=null){let r=String(a.eggId),l=Ke?.[r],s=l?.coinPrice??a.price??a.cost??a.amount??null,f=l?.name??r;return{...a,name:f,price:s,priceFmt:s!=null?ot(s):null}}let i={};for(let r of Object.keys(a))i[r]=n(a[r]);return i};return n(e)}catch{return{}}}async function vt(){let t=await hn();return{seeds:rt(t,mn),tools:rt(t,pn),eggs:rt(t,fn)}}var Ue={seeds:new Map,tools:new Map,eggs:new Map},Ce={seeds:new Set,tools:new Set,eggs:new Set},se={seeds:new Map,tools:new Map,eggs:new Map};function Ct(t,e){let n=gn(e);return se[t].get(n)??0}function Sn(t,e){if(t==="seeds"){let a=e.species??e.name;a&&te({type:"PurchaseSeed",species:a});return}if(t==="tools"){let a=e.toolId??e.id??e.name;a!=null&&te({type:"PurchaseTool",toolId:a});return}let n=e.eggId??e.id??e.name;n!=null&&te({type:"PurchaseEgg",eggId:n})}function wn(t,e,n){let a=st(t,e),i=it(t,e),r=Ue[t],l=Ct(t,i);r.has(a)||r.set(a,{sent:0,total:n,confirmed:0,active:!1,autoKey:i,baseline:l});let s=r.get(a);if(s.total=Math.max(s.total,n),s.sent===0&&(s.baseline=l),s.active)return;s.active=!0;let f=()=>{if(s.confirmed>=s.total){s.active=!1,Ce[t].add(a);return}s.sent<s.total?(Sn(t,e),s.sent++,setTimeout(f,25)):(s.active=!1,Ce[t].add(a))};f()}function Pt(t,e,n){for(let a of e){let i=it(t,a),r=st(t,a),l=Mt(a);n.has(i)&&(Ce[t].has(r)||typeof l!="number"||l<=0||wn(t,a,l))}}async function It(){let t=q("myInventoryAtom");if(!t)return;let e;try{e=await j(t)}catch{return}if(!(!e||!Array.isArray(e.items))){se.seeds.clear(),se.tools.clear(),se.eggs.clear();for(let n of e.items){let a=typeof n.quantity=="number"?n.quantity:0;n.itemType==="Seed"&&n.species?se.seeds.set(String(n.species),(se.seeds.get(String(n.species))??0)+a):n.itemType==="Tool"&&n.toolId!=null?se.tools.set(String(n.toolId),(se.tools.get(String(n.toolId))??0)+a):n.itemType==="Egg"&&n.eggId!=null&&se.eggs.set(String(n.eggId),(se.eggs.get(String(n.eggId))??0)+a)}["seeds","tools","eggs"].forEach(n=>{Ue[n].forEach(a=>{let i=Ct(n,a.autoKey),r=Math.max(0,i-a.baseline);a.confirmed=Math.min(r,a.total),a.active&&a.confirmed>=a.total&&(a.active=!1)})})}}async function Et(){await(async()=>{try{await z()}catch{}})();let t=bn();t.size,await It();let e={seeds:null,tools:null,eggs:null},n={},a=(s,f)=>f.map(S=>st(s,S)).sort().join("|");async function i(s=!1){let f=await vt();["seeds","tools","eggs"].forEach(S=>{let E=f[S].items||[];s&&(Ce[S].clear(),Ue[S].clear()),Pt(S,E,t),e[S]=f[S].sec,n[S]=a(S,E)})}let r=q("myInventoryAtom");if(r)try{ee(r,async()=>{await It()}).catch(()=>{})}catch{}let l=q("shopsAtom");if(l)try{ee(l,async()=>{let s=await vt();["seeds","tools","eggs"].forEach(f=>{let S=s[f].items||[],E=s[f].sec,A=e[f],N=a(f,S),K=n[f],L=!1;E!=null&&A!=null?E>A&&(L=!0):E==null&&K!=null&&N!==K&&(L=!0),e[f]=E,n[f]=N,L&&(Ce[f].clear(),Ue[f].clear(),Pt(f,S,t))})}).catch(()=>{})}catch{}i(!0).catch(()=>{})}function Rt(t){t.innerHTML=`
    <div class="row">
      <label>X</label><input id="pl-x" type="number" min="0" max="99" step="1" value="14">
      <label>Y</label><input id="pl-y" type="number" min="0" max="99" step="1" value="14">
      <button id="pl-tp">Teleport</button>
    </div>
  `;let e=l=>t.querySelector(l),n=e("#pl-x"),a=e("#pl-y"),i=e("#pl-tp");try{let l=localStorage.getItem("menu:player:xy");if(l){let{sx:s,sy:f}=JSON.parse(l);s!=null&&(n.value=String(s)),f!=null&&(a.value=String(f))}}catch{}let r=()=>{try{localStorage.setItem("menu:player:xy",JSON.stringify({sx:+n.value,sy:+a.value}))}catch{}};i.onclick=async()=>{let l=+n.value,s=+a.value;try{await Ie(l,s)}catch(f){console.warn("[PlayerMenu] setLocalPlayerPosition failed:",f)}te({type:"Teleport",position:{x:l,y:s}}),r()}}var de=class{constructor(e={}){this.opts=e;V(this,"root");V(this,"tabBar");V(this,"views");V(this,"tabs",new Map);V(this,"events",new Map);V(this,"currentId",null);V(this,"lsKeyActive");this.lsKeyActive=`menu:${e.id||"default"}:activeTab`}mount(e){if(this.ensureStyles(),e.innerHTML="",this.root=W("div",`qmm ${this.opts.classes||""} ${this.opts.compact?"qmm-compact":""}`),this.opts.startHidden&&(this.root.style.display="none"),this.tabBar=W("div","qmm-tabs"),this.views=W("div","qmm-views"),this.root.appendChild(this.tabBar),this.root.appendChild(this.views),e.appendChild(this.root),this.tabs.size){for(let[n,a]of this.tabs)this.createTabView(n,a);this.restoreActive()}this.updateTabsBarVisibility(),this.emit("mounted")}unmount(){this.root?.parentElement&&this.root.parentElement.removeChild(this.root),this.emit("unmounted")}setVisible(e){this.root&&(this.root.style.display=e?"":"none",this.emit(e?"show":"hide"))}toggle(){if(!this.root)return!1;let e=this.root.style.display==="none";return this.setVisible(e),e}addTab(e,n,a){return this.tabs.set(e,{title:n,render:a,badge:null}),this.root&&(this.createTabView(e,this.tabs.get(e)),this.updateTabsBarVisibility()),this}addTabs(e){return e.forEach(n=>this.addTab(n.id,n.title,n.render)),this}setTabTitle(e,n){let a=this.tabs.get(e);if(a&&(a.title=n,a.btn)){let i=a.btn.querySelector(".label");i&&(i.textContent=n)}}setTabBadge(e,n){let a=this.tabs.get(e);!a||!a.btn||(a.badge||(a.badge=document.createElement("span"),a.badge.className="badge",a.btn.appendChild(a.badge)),n==null||n===""?a.badge.style.display="none":(a.badge.textContent=n,a.badge.style.display=""))}refreshTab(e){let n=this.tabs.get(e);if(!n?.view)return;let a=this.findScrollableAncestor(n.view),i=a?a.scrollTop:null,r=a?a.scrollLeft:null,l=document.activeElement?.id||null;n.view.innerHTML="";try{n.render(n.view,this)}catch(s){n.view.textContent=String(s)}this.currentId===e&&this.switchTo(e),this.emit("tab:render",e),a&&i!=null&&requestAnimationFrame(()=>{try{a.scrollTop=i,a.scrollLeft=r??0}catch{}if(l){let s=document.getElementById(l);if(s&&s.focus)try{s.focus()}catch{}}})}findScrollableAncestor(e){function n(i){let r=getComputedStyle(i),l=r.overflowY||r.overflow;return/(auto|scroll)/.test(l)&&i.scrollHeight>i.clientHeight}let a=e;for(;a;){if(n(a))return a;a=a.parentElement}return document.querySelector(".qws-win")}firstTabId(){let e=this.tabs.keys().next();return e.done?null:e.value??null}getTabView(e){return this.tabs.get(e)?.view??null}removeTab(e){let n=this.tabs.get(e);if(!n)return;this.tabs.delete(e);let a=this.tabBar?.querySelector(`button[data-id="${At(e)}"]`);if(a&&a.parentElement&&a.parentElement.removeChild(a),n.view&&n.view.parentElement&&n.view.parentElement.removeChild(n.view),this.currentId===e){let i=this.tabs.keys().next().value||null;this.switchTo(i)}this.updateTabsBarVisibility()}switchTo(e){this.currentId=e,[...this.tabBar.children].forEach(n=>n.classList.toggle("active",n.dataset.id===e||e===null)),[...this.views.children].forEach(n=>n.classList.toggle("active",n.dataset.id===e||e===null)),this.persistActive(),this.emit("tab:change",e)}on(e,n){return this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(n),()=>this.off(e,n)}off(e,n){this.events.get(e)?.delete(n)}emit(e,...n){this.events.get(e)?.forEach(a=>{try{a(...n)}catch{}})}btn(e,n){let a=W("button","qmm-btn",`<span class="label">${Ve(e)}</span>`);return a.onclick=n,a}label(e){let n=W("label","qmm-label");return n.textContent=e,n}row(...e){let n=W("div","qmm-row");return e.forEach(a=>n.appendChild(a)),n}section(e){let n=W("div","qmm-section");return n.appendChild(W("div","qmm-section-title",Ve(e))),n}inputNumber(e=0,n=9999,a=1,i=0){let r=W("input","qmm-input");return r.type="number",r.min=String(e),r.max=String(n),r.step=String(a),r.value=String(i),r}inputText(e="",n=""){let a=W("input","qmm-input");return a.type="text",a.placeholder=e,a.value=n,a}checkbox(e=!1){let n=W("input","qmm-check");return n.type="checkbox",n.checked=e,n}radio(e,n,a=!1){let i=W("input","qmm-radio");return i.type="radio",i.name=e,i.value=n,i.checked=a,i}slider(e=0,n=100,a=1,i=0){let r=W("input","qmm-range");return r.type="range",r.min=String(e),r.max=String(n),r.step=String(a),r.value=String(i),r}switch(e=!1){let n=this.checkbox(e);return n.classList.add("qmm-switch"),n}table(e){let n=W("div","qmm-table-wrap"),a=document.createElement("table");a.className="qmm-table";let i=document.createElement("thead"),r=document.createElement("tr");e.forEach(s=>{let f=document.createElement("th");f.textContent=s,r.appendChild(f)}),i.appendChild(r),a.appendChild(i);let l=document.createElement("tbody");return a.appendChild(l),n.appendChild(a),{root:n,tbody:l}}radioGroup(e,n,a,i){let r=W("div","qmm-radio-group");for(let{value:l,label:s}of n){let f=this.radio(e,l,a===l),S=document.createElement("label");S.className="qmm-radio-label",S.appendChild(f),S.appendChild(document.createTextNode(s)),f.onchange=()=>{f.checked&&i(l)},r.appendChild(S)}return r}bindLS(e,n,a,i,r){try{let l=localStorage.getItem(e);l!=null&&a(i(l))}catch{}return{save:()=>{try{localStorage.setItem(e,r(n()))}catch{}}}}split2(e="260px"){let n=W("div","qmm-split");n.style.gridTemplateColumns="minmax(160px, max-content) 1fr";let a=W("div","qmm-split-left"),i=W("div","qmm-split-right");return n.appendChild(a),n.appendChild(i),{root:n,left:a,right:i}}vtabs(e={}){return new lt(this,e)}createTabView(e,n){let a=document.createElement("button");a.className="qmm-tab",a.dataset.id=e,a.innerHTML=`<span class="label">${Ve(n.title)}</span><span class="badge" style="display:none"></span>`;let i=a.querySelector(".badge");n.btn=a,n.badge=i,a.onclick=()=>this.switchTo(e),this.tabBar.appendChild(a);let r=W("div","qmm-view");r.dataset.id=e,n.view=r,this.views.appendChild(r);try{n.render(r,this)}catch(l){r.textContent=String(l)}this.currentId||this.switchTo(e)}persistActive(){if(this.currentId)try{localStorage.setItem(this.lsKeyActive,this.currentId)}catch{}}restoreActive(){let e=null;try{e=localStorage.getItem(this.lsKeyActive)}catch{}e&&this.tabs.has(e)?this.switchTo(e):this.tabs.size&&this.switchTo(this.firstTabId())}updateTabsBarVisibility(){if(!this.tabBar||!this.root)return;this.tabs.size>0?(this.tabBar.parentElement||this.root.insertBefore(this.tabBar,this.views),this.tabBar.style.display="flex",this.root.classList.remove("qmm-no-tabs")):(this.tabBar.parentElement&&this.tabBar.parentElement.removeChild(this.tabBar),this.root.classList.add("qmm-no-tabs"))}ensureStyles(){if(document.getElementById("__qmm_css__"))return;let e=`
    .qmm{display:flex;flex-direction:column;gap:8px}
    .qmm-compact{gap:6px}

    /* ---------- TABS plein largeur ---------- */
    .qmm-tabs{
        display:flex; gap:6px; flex-wrap:nowrap; align-items:flex-end;
        border-bottom:1px solid #ffffff22; padding:0 6px;
        position:relative; isolation:isolate;
    }
    .qmm-no-tabs .qmm-views{margin-top:0} /* pas de marge si pas de tabs */

    .qmm-tab{
        flex:1 1 0; min-width:0;
        cursor:pointer; display:inline-flex; justify-content:center; align-items:center; gap:8px;
        padding:8px 12px;
        background:transparent; color:#e8e8e8;
        border:1px solid transparent; border-bottom:none;
        border-top-left-radius:8px; border-top-right-radius:8px;
        transition:background .18s ease,border-color .18s ease,color .18s ease,box-shadow .18s ease;
        position:relative; margin:0; margin-bottom:-1px;
    }
    .qmm-compact .qmm-tab{padding:6px 10px}
    .qmm-tab:hover{background:#ffffff10;color:#fff}
    .qmm-tab:focus-visible{outline:2px solid #79a6ff; outline-offset:2px; border-radius:10px}

    .qmm-tab .badge{
        font-size:11px; line-height:1; padding:2px 6px; border-radius:999px;
        background:#ffffff14; border:1px solid #ffffff26
    }

    .qmm-tab.active{
        background:#0b0b0bcc; color:#fff;
        border-color:#ffffff26; border-bottom-color:transparent;
        z-index:1; box-shadow:0 -1px 0 #0b0b0bcc inset;
    }

     /* ---------- SWITCH ---------- */
    .qmm-switch {
      appearance: none;
      width: 36px; height: 20px;
      background: #666a;
      border-radius: 20px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .qmm-switch::before {
      content: "";
      position: absolute;
      top: 2px; left: 2px;
      width: 16px; height: 16px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }
    .qmm-switch:checked {
      background: #79a6ff;
    }
    .qmm-switch:checked::before {
      transform: translateX(16px);
    }

    /* ---------- RADIO GROUP ---------- */
    .qmm-radio-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .qmm-radio-label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    /* ---------- PANNEAUX ---------- */
    .qmm-views{
        border:1px solid #ffffff26; border-radius:8px; padding:12px; background:#0b0b0b80;
    }
    .qmm-compact .qmm-views{padding:8px}
    .qmm-tabs + .qmm-views{margin-top:-1px}

    .qmm-view{display:none}
    .qmm-view.active{display:block}

    /* ---------- LAYOUT & CONTROLES ---------- */
    .qmm-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
    .qmm-section{margin-top:6px}
    .qmm-section-title{font-weight:600;margin:2px 0 6px 0}

    .qmm-btn{cursor:pointer;border-radius:8px;border:1px solid #ffffff30;padding:6px 10px;background:#ffffff12;color:#fff}
    .qmm-compact .qmm-btn{padding:5px 8px}
    .qmm-btn:hover{background:#ffffff22}

    .qmm-input{min-width:80px;background:#0006;color:#fff;border:1px solid #ffffff30;border-radius:6px;padding:6px 8px}
    .qmm-range{width:160px}
    .qmm-check,.qmm-radio{transform:scale(1.1)}
    .qmm-label{opacity:.9}
    .qmm-val{min-width:24px;text-align:center}

    /* ---------- TABLE ---------- */
    .qmm-table-wrap{ /* plus de max-height: s'adapte au contenu */ }
    .qmm-table{border-collapse:collapse;width:100%}
    .qmm-table th,.qmm-table td{border-bottom:1px solid #ffffff15;padding:6px 8px;text-align:left;vertical-align:middle}
    .qmm-table th{opacity:.85;font-weight:600;position:sticky;top:0;background:#0b0b0bcc;backdrop-filter:blur(2px)}

    /* ---------- SPLIT (2 colonnes) sans hauteur forc\xE9e ---------- */
    .qmm-split{
      display:grid; gap:12px;
      grid-template-columns:260px 1fr; /* ajust\xE9e via style inline par split2(...) */
      align-items:start; /* la hauteur suit le contenu le plus haut */
    }
    .qmm-split-left{display:flex;flex-direction:column;gap:8px}
    .qmm-split-right{
      border:1px solid #ffffff26; border-radius:10px; padding:12px;
      display:flex; flex-direction:column; gap:12px;
      background:#0b0b0b80;
    }

    /* ---------- VTABS sans max-height par d\xE9faut ---------- */
    .qmm-vtabs{display:flex;flex-direction:column;gap:8px}
    .qmm-vtabs .filter{display:block}
    .qmm-vtabs .filter input{width:100%}
    .qmm-vlist{
      flex:0 0 auto; /* pas de croissance forc\xE9e */
      overflow:visible; /* pas de scroll interne par d\xE9faut */
      border:1px solid #4446; border-radius:10px; padding:6px;
      background:transparent;
    }
    .qmm-vtab{
      width:100%; text-align:left; cursor:pointer;
      display:grid; grid-template-columns:28px 1fr auto; align-items:center; gap:8px;
      padding:6px 8px; border-radius:8px; border:1px solid #4444; background:transparent; color:inherit;
    }
    .qmm-vtab:hover{background:#ffffff10}
    .qmm-vtab.active{background:rgba(120,120,255,0.12)}
    .qmm-dot{width:10px;height:10px;border-radius:50%;justify-self:center}
    .qmm-chip{
      display:flex; align-items:center; gap:8px; min-width:0;
    }
    .qmm-chip img{
      width:20px;height:20px;border-radius:50%;object-fit:cover;border:1px solid #4446
    }
    .qmm-chip .t{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .qmm-tag{font-size:11px;line-height:1;padding:2px 6px;border-radius:999px;background:#ffffff14;border:1px solid #ffffff26}
    `,n=document.createElement("style");n.id="__qmm_css__",n.textContent=e,(document.documentElement||document.body).appendChild(n)}},lt=class{constructor(e,n={}){this.api=e;this.opts=n;V(this,"root");V(this,"filterWrap",null);V(this,"filterInput",null);V(this,"list");V(this,"items",[]);V(this,"selectedId",null);V(this,"onSelectCb");V(this,"renderItemCustom");V(this,"emptyText");this.root=W("div","qmm-vtabs"),this.emptyText=n.emptyText||"Aucun \xE9l\xE9ment.",this.renderItemCustom=n.renderItem,n.filterPlaceholder&&(this.filterWrap=W("div","filter"),this.filterInput=document.createElement("input"),this.filterInput.type="search",this.filterInput.placeholder=n.filterPlaceholder,this.filterInput.className="qmm-input",this.filterInput.oninput=()=>this.renderList(),this.filterWrap.appendChild(this.filterInput),this.root.appendChild(this.filterWrap)),this.list=W("div","qmm-vlist"),n.maxHeightPx&&(this.list.style.maxHeight=`${n.maxHeightPx}px`,this.list.style.overflow="auto",this.list.style.flex="1 1 auto"),this.root.appendChild(this.list),this.selectedId=n.initialId??null,this.onSelectCb=n.onSelect}setItems(e){this.items=Array.isArray(e)?e.slice():[],this.selectedId&&!this.items.some(n=>n.id===this.selectedId)&&(this.selectedId=this.items[0]?.id??null),this.renderList()}getSelected(){return this.items.find(e=>e.id===this.selectedId)??null}select(e){this.selectedId=e,this.renderList(),this.onSelectCb?.(this.selectedId,this.getSelected())}onSelect(e){this.onSelectCb=e}setBadge(e,n){let a=this.list.querySelector(`button[data-id="${At(e)}"]`);if(!a)return;let i=a.querySelector(".qmm-tag");!i&&n!=null&&(i=W("span","qmm-tag"),a.appendChild(i)),i&&(n==null||n===""?i.style.display="none":(i.textContent=n,i.style.display=""))}getFilter(){return(this.filterInput?.value||"").trim().toLowerCase()}renderList(){let e=this.list.scrollTop;this.list.innerHTML="";let n=this.getFilter(),a=n?this.items.filter(r=>(r.title||"").toLowerCase().includes(n)||(r.subtitle||"").toLowerCase().includes(n)):this.items;if(!a.length){let r=document.createElement("div");r.style.opacity="0.75",r.textContent=this.emptyText,this.list.appendChild(r);return}let i=document.createElement("ul");i.style.listStyle="none",i.style.margin="0",i.style.padding="0",i.style.display="flex",i.style.flexDirection="column",i.style.gap="4px";for(let r of a){let l=document.createElement("li"),s=document.createElement("button");if(s.className="qmm-vtab",s.dataset.id=r.id,s.disabled=!!r.disabled,this.renderItemCustom)this.renderItemCustom(r,s);else{let f=W("div","qmm-dot");f.style.background=r.statusColor||"#999a";let S=W("div","qmm-chip"),E=document.createElement("img");E.src=r.avatarUrl||"",E.alt=r.title;let A=document.createElement("div");A.style.display="flex",A.style.flexDirection="column",A.style.gap="2px";let N=W("div","t");N.textContent=r.title;let K=document.createElement("div");if(K.textContent=r.subtitle||"",K.style.opacity="0.7",K.style.fontSize="12px",r.subtitle||(K.style.display="none"),A.appendChild(N),A.appendChild(K),S.appendChild(E),S.appendChild(A),s.appendChild(f),s.appendChild(S),r.badge!=null){let L=W("span","qmm-tag",Ve(String(r.badge)));s.appendChild(L)}else{let L=document.createElement("div");L.style.width="0",s.appendChild(L)}}s.classList.toggle("active",r.id===this.selectedId),s.onclick=()=>this.select(r.id),l.appendChild(s),i.appendChild(l)}this.list.appendChild(i),this.list.scrollTop=e}};function W(t,e,n){let a=document.createElement(t);return e&&(a.className=e),n!=null&&(a.innerHTML=n),a}function At(t){return t.replace(/"/g,'\\"')}function Ve(t){return t.replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}var Lt=["Baker's Wheat","Thumbcorn","Cronerice","Gildmillet","Queenbeet","Duketater"],qt="garden:autoHarvest:opts";function kt(t){let e=new de({id:"garden",classes:"qmm-garden",compact:!0});e.mount(t),e.addTab("auto-plant","Auto plant",i=>{i.appendChild(e.section("Auto plant")),i.appendChild(e.row(e.label("\xC0 compl\xE9ter\u2026 (semis auto, patterns, cycles, etc.)")))}),e.addTab("auto-harvest","Auto harvest",i=>{let r=n(),l=e.section("Mutation"),s=e.radioGroup("garden-mutation",[{value:"None",label:"None"},{value:"Gold",label:"Gold"},{value:"Rainbow",label:"Rainbow"}],r.mutation,h=>{r.mutation=h,a(r)});l.appendChild(s),i.appendChild(l);let f=e.section("Weather condition"),S=e.radioGroup("garden-weather",[{value:"None",label:"None"},{value:"Wet",label:"Wet"},{value:"Chilled",label:"Chilled"},{value:"Frozen",label:"Frozen"}],r.weather,h=>{r.weather=h,a(r)});f.appendChild(S),i.appendChild(f);let E=e.section("Harvest & Dawn"),A=e.radioGroup("garden-hd",[{value:"None",label:"None"},{value:"Dawnlit",label:"Dawnlit"},{value:"Ambershine",label:"Ambershine"}],r.harvestDawn,h=>{r.harvestDawn=h,a(r)});E.appendChild(A),i.appendChild(E);let N=e.section("Plants selection"),{root:K,tbody:L}=e.table(["Plant","Enable"]);for(let h of Lt)h in r.enabledPlants||(r.enabledPlants[h]=!1);for(let h of Lt){let G=document.createElement("tr"),F=document.createElement("td");F.textContent=h;let O=document.createElement("td"),_=e.switch(!!r.enabledPlants[h]);_.onchange=()=>{r.enabledPlants[h]=_.checked,a(r)},O.appendChild(_),G.appendChild(F),G.appendChild(O),L.appendChild(G)}N.appendChild(K),i.appendChild(N)}),e.addTab("tools","Tools",i=>{i.appendChild(e.section("Tools")),i.appendChild(e.row(e.label("\xC0 compl\xE9ter\u2026 (ex : nettoyer le champ, presets, etc.)")))});function n(){try{let i=localStorage.getItem(qt);if(i){let r=JSON.parse(i),l=r.mutation??null;l&&typeof l=="object"&&(r.mutation.gold?l="Gold":r.mutation.rainbow?l="Rainbow":l=null);let s=r.harvestDawn??null;!s&&r.specials&&typeof r.specials=="object"&&(r.specials.Dawnlit?s="Dawnlit":r.specials.Ambershine&&(s="Ambershine"));let f=r.weather&&typeof r.weather=="string"?r.weather:null,S=r.enabledPlants&&typeof r.enabledPlants=="object"?r.enabledPlants:{};return{mutation:l,weather:f,harvestDawn:s,enabledPlants:S}}}catch{}return{mutation:null,weather:null,harvestDawn:null,enabledPlants:{}}}function a(i){try{localStorage.setItem(qt,JSON.stringify(i))}catch{}}}var Bt="menu:shops:auto";async function Wt(t){await(async()=>{try{await z()}catch{}})();let e=new de({id:"shops",compact:!0});e.mount(t);let n=fe(),a={seeds:null,tools:null,eggs:null},i={},r={seeds:new Set,tools:new Set,eggs:new Set},l={seeds:new Map,tools:new Map,eggs:new Map},s={seeds:new Map,tools:new Map,eggs:new Map};e.addTabs([{id:"seeds",title:"Seeds",render:u=>f(u,"seeds")},{id:"tools",title:"Tools",render:u=>f(u,"tools")},{id:"eggs",title:"Eggs",render:u=>f(u,"eggs")}]);function f(u,p){u.innerHTML="";let m=document.createElement("div");m.className="qmm-row";let w=e.btn("Refresh all",async()=>Ae(!0)),o=e.btn("Clear auto (tab)",()=>{let d=p+":";[...n].forEach(g=>{g.startsWith(d)&&n.delete(g)}),ve(),e.refreshTab(p)});m.appendChild(w),m.appendChild(o),u.appendChild(m);let{root:c,tbody:y}=e.table(S(p));u.appendChild(c),U(p,y).catch(()=>{})}function S(u){switch(u){case"seeds":return["Seed","Price","Qty","Bought","Auto-buy"];case"tools":return["Tool","Price","Qty","Bought","Auto-buy"];case"eggs":return["Egg","Price","Qty","Bought","Auto-buy"]}}async function E(){let u=q("shopsAtom");if(!u)return{};let p=m=>{let w=typeof m=="number"?m:Number(m);if(!isFinite(w))return w===1/0?"\u221E":null;let o=Math.abs(w),c=y=>y%1===0?String(y):y.toFixed(1);return o>=1e12?`${c(w/1e12)}T`:o>=1e9?`${c(w/1e9)}B`:o>=1e6?`${c(w/1e6)}M`:o>=1e3?`${c(w/1e3)}k`:String(w)};try{let m=await j(u);if(!m||typeof m!="object")return{};let w=o=>{if(Array.isArray(o))return o.map(w);if(!o||typeof o!="object")return o;if((o.itemType==="Seed"||"species"in o)&&typeof o.species=="string"){let y=o.species,d=je?.[y],g=d?.seed?.coinPrice??o.price??o.cost??o.amount??null,M=d?.seed?.name??d?.name??y;return{...o,name:M,price:g,priceFmt:g!=null?p(g):null}}if((o.itemType==="Tool"||"toolId"in o)&&o.toolId!=null){let y=String(o.toolId),d=$e?.[y],g=d?.coinPrice??o.price??o.cost??o.amount??null,M=d?.name??y;return{...o,name:M,price:g,priceFmt:g!=null?p(g):null}}if((o.itemType==="Egg"||"eggId"in o)&&o.eggId!=null){let y=String(o.eggId),d=Ke?.[y],g=d?.coinPrice??o.price??o.cost??o.amount??null,M=d?.name??y;return{...o,name:M,price:g,priceFmt:g!=null?p(g):null}}let c={};for(let y of Object.keys(o))c[y]=w(o[y]);return c};return w(m)}catch{return{}}}async function A(){let u=await E();return N(u)}function N(u){return{seeds:F(u,K),tools:F(u,L),eggs:F(u,h)}}function K(u){return u&&typeof u=="object"&&"species"in u}function L(u){return u&&typeof u=="object"&&"toolId"in u}function h(u){return u&&typeof u=="object"&&"eggId"in u}function G(u){if(!u||typeof u!="object")return null;if(typeof u.secondsUntilRestock=="number")return u.secondsUntilRestock;for(let p of Object.keys(u)){let m=u[p];if(typeof m=="number"&&p.toLowerCase().includes("secondsuntilrestock"))return m}return null}function F(u,p){let m=new Set,w=[u];for(;w.length;){let o=w.pop();if(!(!o||typeof o!="object")&&!m.has(o)){m.add(o);for(let c of Object.keys(o)){let y=o[c];if(Array.isArray(y)&&y.length&&y.every(d=>typeof d=="object")&&y.some(p)){let d=G(o);return{items:y,sec:d}}}for(let c of Object.keys(o)){let y=o[c];y&&typeof y=="object"&&w.push(y)}}}return{items:[],sec:null}}function O(u){let p=u.initialStock??u.qty??u.quantity??u.remaining??u.stock;return typeof p=="number"?p:p==null?"":Number(p)||0}function _(u,p){return u==="seeds"?`seeds:${p.species??p.name??"Unknown"}`:u==="tools"?`tools:${p.toolId??p.id??p.name??"Unknown"}`:`eggs:${p.eggId??p.id??p.name??"Unknown"}`}function X(u,p){let m=_(u,p),w=p.price??p.cost??p.amount??"",o=O(p);return`${m}@${w}#${o}`}function ye(u,p){return p.map(m=>X(u,m)).sort().join("|")}async function U(u,p){let w=(await A())[u].items||[];if(p.innerHTML="",e.setTabBadge(u,w.length?String(w.length):null),!w.length){let o=document.createElement("tr"),c=document.createElement("td");c.colSpan=5,c.textContent="No items",c.style.opacity="0.8",o.appendChild(c),p.appendChild(o);return}for(let o of w){let c=document.createElement("tr"),y=u==="seeds"?o.name??o.species??"?":u==="tools"?o.name??o.toolId??o.id??"?":o.name??o.eggId??o.id??"?";C(c,String(y));let d=o.priceFmt??o.price??o.cost??o.amount??"";C(c,d===""?"?":String(d));let g=O(o);C(c,g===""?"\u2014":String(g));let M=X(u,o),x=l[u].get(M),T=document.createElement("td");n.has(_(u,o))&&x?x.total>0&&x.confirmed>=x.total?T.textContent=`\u2713 ${x.total}`:T.textContent=`${x.confirmed}/${x.total||0}`:T.textContent="\u2014",c.appendChild(T);let I=_(u,o),D=document.createElement("td"),R=document.createElement("input");R.type="checkbox",R.checked=n.has(I),R.onchange=()=>{if(R.checked){n.add(I),ve(),Ee(u,o);let b=O(o);T.textContent=typeof b=="number"&&b>0?`0/${b}`:"0/0"}else n.delete(I),ve(),T.textContent="\u2014"},D.appendChild(R),c.appendChild(D),p.appendChild(c)}}function C(u,p){let m=document.createElement("td");m.textContent=p,u.appendChild(m)}function me(u,p){let m=p.indexOf(":");return m>=0?p.slice(m+1):p}function pe(u,p){let m=me(u,p);return s[u].get(m)??0}async function ge(){let u=q("myInventoryAtom");if(!u)return;let p;try{p=await j(u)}catch{return}if(!(!p||!Array.isArray(p.items))){s.seeds.clear(),s.tools.clear(),s.eggs.clear();for(let m of p.items){let w=typeof m.quantity=="number"?m.quantity:0;m.itemType==="Seed"&&m.species?s.seeds.set(String(m.species),(s.seeds.get(String(m.species))??0)+w):m.itemType==="Tool"&&m.toolId!=null?s.tools.set(String(m.toolId),(s.tools.get(String(m.toolId))??0)+w):m.itemType==="Egg"&&m.eggId!=null&&s.eggs.set(String(m.eggId),(s.eggs.get(String(m.eggId))??0)+w)}["seeds","tools","eggs"].forEach(m=>{let w=!1;l[m].forEach((o,c)=>{let y=pe(m,o.autoKey),d=Math.max(0,y-o.baseline);d!==o.confirmed&&(o.confirmed=Math.min(d,o.total),w=!0),o.active&&o.confirmed>=o.total&&(o.active=!1,r[m].add(c),o.source==="autobuy"&&!o.notified&&(o.notified=!0,ie("Auto-buy","Purchased success.","success")))}),w&&e.refreshTab(m)})}}let le=q("myInventoryAtom");if(le)try{ee(le,async()=>{await ge()}).catch(()=>{}),await ge()}catch{}function we(u,p){if(u==="seeds"){let w=p.species??p.name;w&&te({type:"PurchaseSeed",species:w});return}if(u==="tools"){let w=p.toolId??p.id??p.name;w!=null&&te({type:"PurchaseTool",toolId:w});return}let m=p.eggId??p.id??p.name;m!=null&&te({type:"PurchaseEgg",eggId:m})}function Ee(u,p){let m=O(p);typeof m=="number"&&m>0&&Re(u,p,m,"autobuy")}function Re(u,p,m,w="manual"){let o=X(u,p),c=_(u,p),y=l[u],d=pe(u,c);y.has(o)||y.set(o,{sent:0,total:m,confirmed:0,active:!1,autoKey:c,baseline:d,source:w,notified:!1});let g=y.get(o);if(g.total=Math.max(g.total,m),g.sent===0&&(g.baseline=d),g.source=w,g.active)return;g.active=!0;let M=()=>{g.sent<g.total?(we(u,p),g.sent++,(g.sent===g.total||g.sent%5===0)&&e.refreshTab(u),setTimeout(M,25)):(g.active=!1,e.refreshTab(u))};M()}function Te(u,p){for(let m of p){let w=_(u,m),o=X(u,m),c=O(m);n.has(w)&&(r[u].has(o)||typeof c!="number"||c<=0||Re(u,m,c,"autobuy"))}}async function Ae(u=!1){let p=await A();["seeds","tools","eggs"].forEach(m=>{let w=p[m].items||[];u&&(r[m].clear(),l[m].clear()),e.refreshTab(m),Te(m,w),a[m]=p[m].sec,i[m]=ye(m,w)})}let xe=q("shopsAtom");if(xe)try{ee(xe,async()=>{let u=await A();["seeds","tools","eggs"].forEach(p=>{let m=u[p].items||[],w=u[p].sec,o=a[p],c=ye(p,m),y=i[p],d=!1;w!=null&&o!=null?w>o&&(d=!0):w==null&&y!=null&&c!==y&&(d=!0),a[p]=w,i[p]=c,d&&(r[p].clear(),l[p].clear(),e.refreshTab(p),Te(p,m))})}).catch(()=>{})}catch{}await ge(),Ae(!0).catch(()=>{});function fe(){try{let u=localStorage.getItem(Bt);if(u)return new Set(JSON.parse(u))}catch{}return new Set}function ve(){try{localStorage.setItem(Bt,JSON.stringify([...n]))}catch{}}}async function Ht(t){try{await z()}catch{}t.innerHTML=`
    <div class="row" style="gap:8px;align-items:center">
      <button id="dd-capture">Capture store</button>
      <span id="dd-cap">captured: ${String(Se())}</span>
    </div>
    <div class="row" style="gap:8px;align-items:center">
      <input id="dd-filter" placeholder="regex label (ex: position|health)" style="width:260px" />
      <button id="dd-list">List atoms</button>
    </div>
    <div class="row" style="gap:8px;align-items:center">
      <input id="dd-atom" placeholder="exact label (ex: positionAtom)" style="width:260px" />
      <button id="dd-read">Read</button>
      <button id="dd-write">Write</button>
    </div>
    <div class="row" style="gap:8px;align-items:center">
      <button id="dd-pos-get">close inv</button>
      <button id="dd-pos-rand">fake inv</button>
      <button id="dd-sub-pos">Subscribe position</button>
    </div>
    <pre id="dd-out" style="font-size:12px;opacity:.9;max-height:180px;overflow:auto;margin-top:6px"></pre>
  `;let e=r=>t.querySelector(r),n=r=>{let l=e("#dd-out");l.textContent=typeof r=="string"?r:JSON.stringify(r,null,2)},a=()=>{e("#dd-cap").textContent=`captured: ${String(Se())}`};e("#dd-capture").onclick=async()=>{await z(),a(),n(Ge.getCapturedInfo())},e("#dd-list").onclick=()=>{let r=e("#dd-filter").value||".",l=new RegExp(r,"i"),s=Pe(l);console.table(s.map(f=>({label:f?.debugLabel||f?.label||""}))),n(`${s.length} atom(s) listed in console.`)},e("#dd-read").onclick=async()=>{let r=e("#dd-atom").value.trim();if(!r)return n("Enter exact label.");let l=q(r);if(!l)return n("Atom not found.");try{n(await j(l))}catch(s){n(String(s))}},e("#dd-write").onclick=async()=>{let r=e("#dd-atom").value.trim();if(!r)return n("Enter exact label.");let l=q(r);if(!l)return n("Atom not found.");let s=prompt("value (JSON or expression, ex: {x:10,y:5} / prev=>({...prev, hp:100}))","{x:10,y:5}");if(s!=null)try{let f=new Function("prev",`return (${s});`),S=await j(l),E=f(S);await re(l,E),n({ok:!0,after:await j(l)})}catch{try{await re(l,JSON.parse(String(s))),n({ok:!0,after:await j(l)})}catch(f){n(String(f))}}},e("#dd-pos-get").onclick=async()=>{await Ge.fakeInventoryHide()},e("#dd-pos-rand").onclick=async()=>{await Ge.fakeInventoryShow({items:[{itemType:"Tool",toolId:"PlanterPot",quantity:999},{itemType:"Tool",toolId:"WateringCan",quantity:99},{itemType:"Seed",species:"Banana",quantity:123},{itemType:"Egg",eggId:"RareEgg",quantity:7}],favoritedItemIds:[]},{merge:!1,open:!0})};let i=null;e("#dd-sub-pos").onclick=async()=>{if(i){i(),i=null,n("unsubscribed");return}let r=q("positionAtom");if(!r)return n("positionAtom introuvable");i=await ee(r,async()=>{n(await j(r))}),n("subscribed (click again to unsubscribe)")}}function Tn(t){if(!t||typeof t!="object")return[];let e=[],n=new Set,a=[t];for(;a.length;){let r=a.pop();if(!(!r||typeof r!="object"||n.has(r))){n.add(r);for(let l of Object.keys(r)){let s=r[l];Array.isArray(s)&&s.length&&s.every(f=>f&&typeof f=="object")&&s.some(S=>"id"in S&&"name"in S)&&/player/i.test(l)&&e.push(...s),s&&typeof s=="object"&&a.push(s)}}}let i=new Map;for(let r of e)r?.id&&i.set(r.id,r);return[...i.values()]}function xn(t){let e=t?.fullState?.data?.players??t?.data?.players??t?.players;return Array.isArray(e)?e:Tn(t)}function Ot(t){let e=t?.child?.data?.userSlots??t?.fullState?.child?.data?.userSlots??t?.data?.userSlots;return Array.isArray(e)?e:e&&typeof e=="object"?Object.values(e):[]}function vn(t,e){return Ot(t).find(a=>String(a?.playerId??"")===String(e))??null}function Nt(t){if(!t||typeof t!="object")return null;let e=t.position&&typeof t.position=="object"?t.position:null,n=t.data?.position&&typeof t.data.position=="object"?t.data.position:null,a=e??n;return!a||typeof a.x!="number"||typeof a.y!="number"?null:{x:a.x,y:a.y}}function Pn(t){let e=t?.data?.inventory;if(!e||typeof e!="object")return null;let n=Array.isArray(e.items)?e.items:[],a=Array.isArray(e.favoritedItemIds)?e.favoritedItemIds:[];return{items:n,favoritedItemIds:a}}function In(t,e){let n=new Map;for(let a of Ot(e)){if(!a||typeof a!="object")continue;let i=a.playerId!=null?String(a.playerId):"";if(!i)continue;let r=Nt(a),l=Pn(a);n.set(i,{x:r?.x,y:r?.y,inventory:l??null})}return t.map(a=>{let i=n.get(String(a.id));return i?{...a,...i}:{...a,inventory:null}})}async function Mn(){let t=q("stateAtom");if(!t)return[];let e;try{e=await j(t)}catch{return[]}let n=xn(e);return In(n,e).slice().sort((i,r)=>(i.isConnected?0:1)-(r.isConnected?0:1)||(i.name||"").localeCompare(r.name||""))}function Cn(t,e=22){return t?t.length<=e?t:t.slice(0,e-1)+"\u2026":""}var En=t=>({id:t.id,title:Cn(t.name||t.id,9),subtitle:t.isConnected?"Online":"Offline",avatarUrl:t.discordAvatarUrl||"",statusColor:t.isConnected?"#48d170":"#999a"});async function Ft(t){await(async()=>{try{await z()}catch{}})();let e=new de({id:"players",compact:!0});e.mount(t);let n=e.root.querySelector(".qmm-views"),{root:a,left:i,right:r}=e.split2("260px");n.appendChild(a);let l=e.vtabs({filterPlaceholder:"Find player\u2026",onSelect:(L,h)=>f(h?.id||null)});i.appendChild(l.root);let s=l.root.querySelector(".filter");if(s){s.style.display="flex",s.style.alignItems="center",s.style.gap="8px";let L=s.querySelector("input");L&&(L.style.flex="1 1 auto",L.style.minWidth="0");let h=document.createElement("button");h.className="qmm-btn",h.title="Refresh",h.setAttribute("aria-label","Refresh"),h.style.width="34px",h.style.height="34px",h.style.padding="0",h.style.display="inline-flex",h.style.alignItems="center",h.style.justifyContent="center",h.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M12 6a6 6 0 0 1 5.66 4H20l-3.5 3.5L13 10h2.34A4 4 0 1 0 16 12h2a6 6 0 1 1-6-6z"/>
      </svg>
    `,h.onclick=async()=>{await N(!0)},s.appendChild(h)}function f(L){r.innerHTML="";let h=L&&S.find(C=>C.id===L)||null;if(!h){let C=document.createElement("div");C.style.opacity="0.75",C.textContent="Select a player on the left.",r.appendChild(C);return}let G=document.createElement("div");G.style.display="flex",G.style.alignItems="center",G.style.gap="12px";let F=document.createElement("img");F.src=h.discordAvatarUrl||"",F.alt=h.name,F.width=48,F.height=48,F.style.borderRadius="50%",F.style.objectFit="cover",F.style.border="1px solid #4446";let O=document.createElement("div"),_=document.createElement("div");_.textContent=h.name||h.id,_.style.fontWeight="600",_.style.fontSize="16px";let X=document.createElement("div");X.style.opacity="0.8",X.style.fontSize="12px";let ye=h.isConnected?"Online":"Offline";X.textContent=ye,O.appendChild(_),O.appendChild(X),G.appendChild(F),G.appendChild(O),r.appendChild(G);let U=document.createElement("div");U.style.display="flex",U.style.gap="8px",U.style.marginTop="8px",U.appendChild(e.btn("Teleport",async()=>{try{let C=typeof h.x=="number"&&typeof h.y=="number"?{x:h.x,y:h.y}:null;if(!C){let me=q("stateAtom"),pe=me?await j(me):null,ge=pe?vn(pe,h.id):null;C=Nt(ge)||null}if(!C){ie("Teleport","Position not found for this player.","warn");return}te({type:"TeleportTo",targetPlayerId:h.id,x:C.x,y:C.y}),await Ie(C.x,C.y),ie("Teleport",`Teleported to ${h.name} (${C.x}, ${C.y})`,"success")}catch(C){ie("Teleport",C?.message||"Error during teleport.","error")}})),U.appendChild(e.btn("Inventory",async()=>{try{let C=h.inventory&&Array.isArray(h.inventory.items)&&h.inventory.items.length>0?h.inventory:null;if(!C||!Array.isArray(C.items)||C.items.length===0){ie("Inventory","No usable inventory for this player.","warn");return}console.log(C),await nt(C,{merge:!1,open:!0}),ie("Inventory",`${h.name}'s inventory displayed.`,"info")}catch(C){ie("Inventory",C?.message||"Error opening inventory.","error")}})),r.appendChild(U)}let S=[],E="";function A(L){return L.map(h=>`${h.id}|${h.name??""}|${h.isConnected?1:0}|${h.inventory?.items?.length??0}`).join(";")}async function N(L=!0){let h=l.getSelected()?.id??null,G=await Mn(),F=A(G);if(F===E)return;E=F,S=G,l.setItems(S.map(En));let O=L&&h&&S.some(_=>_.id===h)?h:S[0]?.id??null;O!==null?l.select(O):f(null)}let K=q("stateAtom");if(K)try{await ee(K,()=>{N(!0).catch(()=>{})})}catch{}await N(!0)}(function(){"use strict";pt(),yt(),at({onRegister(t){t("player","Movement",Rt),t("players","Players",Ft),t("garden","Garden",kt),t("shops","Shops",Wt),t("debug-data","Debug Data",Ht)}}),Et().catch(()=>{})})();})();
